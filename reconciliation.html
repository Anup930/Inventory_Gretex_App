<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reconciliation Overview - Gretex ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script> 
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #222e3c; color: white; padding-top: 20px; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar a { color: #aab8c5; padding: 12px 25px; display: flex; align-items: center; text-decoration: none; transition: 0.3s; font-size: 0.95rem; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid #4e73df; }
        .sidebar-menu { flex-grow: 1; overflow-y: auto; }
        .sidebar-footer { padding: 20px; border-top: 1px solid #3e4b5b; background-color: #1a2530; }

        .main-content { margin-left: 250px; padding: 30px; }
        .card-custom { background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: none; margin-bottom: 30px; transition: transform 0.2s; height: 100%; }
        
        .filter-chip { background-color: #e2e6ea; color: #2c3e50; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; margin-right: 8px; margin-bottom: 8px; border: 1px solid #ced4da; }
        .filter-chip i { cursor: pointer; margin-left: 8px; color: #dc3545; }

        /* SCROLLABLE TABLE STYLING */
        .table-scroll-area { max-height: 320px; overflow-y: auto; border: 1px solid #f0f0f0; border-radius: 8px; }
        .table-scroll-area::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-scroll-area::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .table-scroll-area::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .table-scroll-area::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Sticky Headers */
        .pivot-table th { background-color: #2c3e50; color: white; text-align: center; vertical-align: middle; font-size: 0.85rem; position: sticky; top: 0; z-index: 10; }
        .pivot-table td { text-align: center; vertical-align: middle; font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .pivot-table td:hover { background-color: #f1f3f9; transform: scale(1.05); z-index: 1; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .row-header { background-color: #f8f9fa; font-weight: bold; text-align: left !important; padding-left: 15px !important; width: 180px; position: sticky; left: 0; z-index: 5; border-right: 2px solid #ddd; }
        .grand-total-row { background-color: #e9ecef !important; font-weight: bold; border-top: 2px solid #333; position: sticky; bottom: 0; z-index: 10;}
        .count-badge { font-size: 0.95rem; font-weight: bold; color: #4e73df; }
        
        .stat-box { border-left: 4px solid; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-box h3 { font-weight: 800; margin: 0; font-size: 2rem; }
        .stat-box small { text-transform: uppercase; font-weight: 700; color: #888; font-size: 0.7rem; }

        .chart-container { display: none; height: 320px; position: relative; padding: 10px; cursor: pointer; }
        .select2-container .select2-selection--single { height: 38px; line-height: 38px; border: 1px solid #ced4da; }
        .dropdown-menu { max-height: 300px; overflow-y: auto; }
        
        .row-risk { background-color: #ffe6e6 !important; border-left: 5px solid #dc3545; }
        .row-risk td { color: #a71d2a; }

        /* Fixed Clickable Badge Style */
        .asset-badge-btn { cursor: pointer; font-size: 0.85rem; border: 1px solid #0d6efd; background-color: #e7f1ff !important; color: #0d6efd !important; padding: 5px 10px; border-radius: 20px; display: inline-block; transition: all 0.2s; }
        .asset-badge-btn:hover { background-color: #0d6efd !important; color: white !important; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .select2-results__option[aria-selected=true]:before { content: "\2713"; margin-right: 8px; color: green; font-weight: bold; }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered { display: flex; flex-wrap: wrap; gap: 5px; }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice { background-color: #e2e6ea; border: 1px solid #ced4da; color: #333; font-size: 0.85rem; }
    </style>
    <script>
        const user = JSON.parse(sessionStorage.getItem("user"));
        if (!user) window.location.href = "index.html";
    </script>
</head>
<body>

    <div class="sidebar">
        <h4 class="text-center mt-4 mb-4"><i class="fas fa-warehouse me-2"></i>Gretex ERP</h4>
        <div class="sidebar-menu">
            <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
            <a href="reconciliation.html" class="active"><i class="fas fa-tasks"></i> Reconciliation</a>
            <a href="Emp.html"><i class="fas fa-user-plus"></i> Add Employee</a>
            <a href="asset.html"><i class="fas fa-laptop-medical"></i> Add Asset</a>
            <a href="allocate.html"><i class="fas fa-hand-holding"></i> Allocate Asset</a>
            <a href="Return.html"><i class="fas fa-undo"></i> Return Asset</a>
            <a href="Shift.html"><i class="fas fa-truck-moving"></i> Shift Asset</a>
            <a href="Sticker.html" ><i class="fas fa-tags"></i> Create Sticker</a>
            <a href="AssetHistory.html"><i class="fas fa-history"></i> Asset History</a>
            <a href="EmpHistory.html"><i class="fas fa-user-clock"></i> Emp History</a>
            <a href="Repair.html"><i class="fas fa-tools"></i> Maintenance</a>
            <a href="scrap.html"><i class="fas fa-tools"></i> Scrap Asset</a>
            <a href="stock.html"><i class="fas fa-exchange-alt"></i> Stock In/Out</a>
            <a href="ITChecklist.html"><i class="fas fa-tasks"></i> IT Checklist</a>
            <a href="StockQC.html"><i class="fas fa-clipboard-check"></i> Stock QC</a>
            <a href="data.html"><i class="fas fa-database"></i> Import / Export</a>
           
        </div>
        <div class="sidebar-footer"><a href="#" onclick="logout()" class="mb-3 text-danger"><i class="fas fa-sign-out-alt"></i> Logout</a></div>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold text-dark m-0"><i class="fas fa-chart-pie me-2"></i>Advanced Reconciliation</h3>
                <small class="text-muted">Strategic Inventory Analysis & Employee Ownership</small>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-success fw-bold" onclick="downloadReconciliation()">
                    <i class="fas fa-download me-2"></i>Download Reconciliation
                </button>
                <button class="btn btn-primary fw-bold" onclick="loadData()">
                    <i class="fas fa-sync-alt me-2"></i>Reset & Refresh
                </button>
            </div>
        </div>

        <div class="card-custom p-4">
            <h6 class="text-muted fw-bold mb-3"><i class="fas fa-filter me-2"></i>Global Data Filters</h6>
            <div class="row g-3 align-items-end mb-3">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">1. Select Column</label>
                    <select class="form-select" id="filterColumn" onchange="populateValues()">
                        <option value="" selected disabled>-- Choose Field --</option>
                        <option value="year">Year</option>
                        <option value="category">Category</option>
                        <option value="location">Location</option>
                        <option value="brand">Brand</option>
                        <option value="status">Status</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">2. Select Values (Multiple)</label>
                    <select class="form-select select2" id="filterValue" multiple="multiple">
                        <option value="">-- Select Values --</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100 fw-bold" onclick="addFilter()">
                        <i class="fas fa-plus me-2"></i>Apply Filter
                    </button>
                </div>
                <div class="col-md-4 text-end"><small class="text-muted" id="recordCountDisplay">Records: 0</small></div>
            </div>
            <div id="activeFiltersArea" class="border-top pt-3" style="display:none;">
                <small class="text-muted d-block mb-2">Active Filters:</small>
                <div id="chipsContainer"></div>
            </div>
        </div>

        <div class="card-custom p-4 border-start border-5 border-info">
            <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
                <h5 class="text-dark fw-bold m-0"><i class="fas fa-users-cog me-2 text-info"></i>Employee Asset Ownership</h5>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-filter me-1"></i> Category
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end p-2 shadow" id="filterMenu-ownership"></ul>
                    </div>
                    <button class="btn btn-outline-primary btn-sm fw-bold" onclick="toggleSectionView('ownership')">
                        <i class="fas fa-chart-bar me-1"></i> Toggle View
                    </button>
                </div>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-3"><div class="stat-box" style="border-color: #e74a3b;"><h3 class="text-danger" id="stat-zero">0</h3><small>0 Assets</small></div></div>
                <div class="col-md-3"><div class="stat-box" style="border-color: #1cc88a;"><h3 class="text-success" id="stat-one">0</h3><small>1 Asset</small></div></div>
                <div class="col-md-3"><div class="stat-box" style="border-color: #f6c23e;"><h3 class="text-warning" id="stat-multi">0</h3><small>2-4 Assets</small></div></div>
                <div class="col-md-3"><div class="stat-box" style="border-color: #4e73df;"><h3 class="text-primary" id="stat-hoard">0</h3><small>5+ Assets</small></div></div>
            </div>
            <div class="table-scroll-area" id="table-ownership">
                <table class="table table-bordered table-hover pivot-table mb-0">
                    <thead>
                        <tr>
                            <th class="bg-secondary text-white">Asset Count Bucket</th>
                            <th class="bg-dark text-white">Total Count</th>
                            <th class="bg-success text-white">Employee</th>
                            <th class="bg-info text-white">Other</th>
                            <th class="bg-light text-dark">Action</th>
                        </tr>
                    </thead>
                    <tbody id="ownershipBody"></tbody>
                </table>
            </div>
            <div class="chart-container" id="chart-container-ownership"><canvas id="canvas-ownership"></canvas></div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card-custom p-4 h-100" id="section-year">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold m-0"><i class="fas fa-calendar me-2"></i>Year Wise</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-light" onclick="toggleSectionView('year')"><i class="fas fa-expand"></i></button>
                            <div class="dropdown"><button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="fas fa-filter"></i></button><ul class="dropdown-menu dropdown-menu-end p-2 shadow" id="filterMenu-year"></ul></div>
                        </div>
                    </div>
                    <div class="table-scroll-area" id="table-year"><table class="table table-sm table-bordered pivot-table mb-0"><thead></thead><tbody></tbody></table></div>
                    <div class="chart-container" id="chart-container-year"><canvas id="canvas-year"></canvas></div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card-custom p-4 h-100" id="section-location">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold m-0"><i class="fas fa-map-marker-alt me-2"></i>Location Wise</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-light" onclick="toggleSectionView('location')"><i class="fas fa-expand"></i></button>
                            <div class="dropdown"><button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="fas fa-filter"></i></button><ul class="dropdown-menu dropdown-menu-end p-2 shadow" id="filterMenu-location"></ul></div>
                        </div>
                    </div>
                    <div class="table-scroll-area" id="table-location"><table class="table table-sm table-bordered pivot-table mb-0"><thead></thead><tbody></tbody></table></div>
                    <div class="chart-container" id="chart-container-location"><canvas id="canvas-location"></canvas></div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card-custom p-4 h-100" id="section-brand">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold m-0"><i class="fas fa-tag me-2"></i>Brand Wise</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-light" onclick="toggleSectionView('brand')"><i class="fas fa-expand"></i></button>
                            <div class="dropdown"><button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="fas fa-filter"></i></button><ul class="dropdown-menu dropdown-menu-end p-2 shadow" id="filterMenu-brand"></ul></div>
                        </div>
                    </div>
                    <div class="table-scroll-area" id="table-brand"><table class="table table-sm table-bordered pivot-table mb-0"><thead></thead><tbody></tbody></table></div>
                    <div class="chart-container" id="chart-container-brand"><canvas id="canvas-brand"></canvas></div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card-custom p-4 h-100" id="section-status">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold m-0"><i class="fas fa-info-circle me-2"></i>Status Wise</h6>
                        <button class="btn btn-sm btn-light" onclick="toggleSectionView('status')"><i class="fas fa-expand"></i></button>
                    </div>
                    <div class="table-scroll-area" id="table-status"><table class="table table-sm table-bordered pivot-table mb-0"><thead></thead><tbody></tbody></table></div>
                    <div class="chart-container" id="chart-container-status"><canvas id="canvas-status"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title" id="modalTitle">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="table-responsive" style="max-height: 500px; overflow-y: auto;"><table class="table table-striped table-hover align-middle"><thead class="table-light sticky-top"><tr><th>Asset ID</th><th>Serial No</th><th>Category</th><th>Brand / Model</th><th>Location</th><th>Assigned To</th><th>Status</th></tr></thead><tbody id="detailBody"></tbody></table></div></div></div></div></div>
    
    <div class="modal fade" id="userListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="userListTitle">Employee List</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-6"><label class="small fw-bold">Filter Type</label><select id="modalFilterType" class="form-select form-select-sm" onchange="filterUserList()"><option value="All">All Types</option><option value="Employee">Employee</option><option value="other">Other</option></select></div>
                        <div class="col-md-6"><label class="small fw-bold">Filter Status</label><select id="modalFilterStatus" class="form-select form-select-sm" onchange="filterUserList()"><option value="All">All Statuses</option><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div>
                    </div>
                    <div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Employee Name</th><th>Type</th><th>Status</th><th class="text-center">Asset Count</th><th>Assets Held (Click)</th></tr></thead><tbody id="userListBody"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="singleAssetModal" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="singleAssetTitle"><i class="fas fa-laptop me-2"></i>Asset Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4"><table class="table table-bordered"><tbody id="singleAssetBody"></tbody></table></div>
                <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbypAYvqG8Lw5-tVd-JaE4PNc6FEzkTRsEBr36uqGwA92wTxxMAOAgV9xeW9QPm4Q-0V2w/exec"; 
        let rawAssets = [], rawEmployees = [];
        let filteredData = []; 
        let activeFilters = {}; 
        let currentModalData = []; 
        
        const sections = {
            'year': { row: 'year', col: 'category', statusFilter: new Set(), chart: null },
            'location': { row: 'location', col: 'category', statusFilter: new Set(), chart: null },
            'brand': { row: 'brand', col: 'category', statusFilter: new Set(), chart: null },
            'status': { row: 'status', col: 'category', statusFilter: new Set(), chart: null },
            'ownership': { categoryFilter: new Set(), chart: null, buckets: {} } 
        };

        $(document).ready(function() {
            $('.select2').select2({ 
                theme: 'bootstrap-5',
                closeOnSelect: false,
                placeholder: "-- Select Values --",
                allowClear: true
            });
            loadData();
        });

        // --- NEW DOWNLOAD FUNCTION ---
        function downloadReconciliation() {
            Swal.fire({
                title: 'Working on it!',
                text: 'We are creating the module for Download Reconciliation.',
                icon: 'info',
                confirmButtonText: 'Okay',
                confirmButtonColor: '#198754'
            });
        }

        function cleanName(str) {
            if (!str) return "";
            return str.split('(')[0].trim().toLowerCase();
        }

        async function loadData() {
            Swal.fire({ title: 'Processing...', didOpen: () => Swal.showLoading() });
            activeFilters = {}; 
            try {
                const [assetRes, empRes] = await Promise.all([
                    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getReconciliationOverview" }) }).then(r=>r.json()),
                    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "exportData", sheetName: "Employees" }) }).then(r=>r.json())
                ]);

                if(assetRes.status === "success" && empRes.status === "success") {
                    rawAssets = assetRes.assets.map(a => {
                        let parts = a.id.split('-');
                        a.year = (parts.length >= 2 && !isNaN(parts[1])) ? parts[1] : "Unknown";
                        return a;
                    });
                    
                    const empRows = empRes.data.slice(1);
                    const empHeaders = empRes.data[0];
                    const nameIdx = empHeaders.findIndex(h => h.toString().toLowerCase().includes("name"));
                    const statusIdx = empHeaders.findIndex(h => h.toString().toLowerCase().includes("status"));
                    const typeIdx = empHeaders.findIndex(h => h.toString().toLowerCase().includes("type"));
                    
                    rawEmployees = empRows.map(r => ({
                        name: r[nameIdx],
                        status: r[statusIdx] || 'Active', 
                        type: r[typeIdx] || 'Other' 
                    }));

                    filteredData = [...rawAssets];
                    const allStatuses = new Set(rawAssets.map(a => a.status || "Unknown"));
                    const allCategories = new Set(rawAssets.map(a => a.category || "Uncategorized"));
                    
                    ['year', 'location', 'brand'].forEach(key => {
                        sections[key].statusFilter = new Set(allStatuses);
                        initSectionStatusMenu(key, allStatuses);
                    });
                    sections['status'].statusFilter = new Set(allStatuses);

                    sections['ownership'].categoryFilter = new Set(allCategories);
                    initOwnershipCategoryMenu(allCategories);

                    refreshAllSections();
                    Swal.close();
                } else { throw new Error("Data fetch failed"); }
            } catch(e) { Swal.fire("Error", "Failed to load data.", "error"); }
        }

        // --- MULTI-SELECT FILTER LOGIC ---
        function populateValues() {
            const col = document.getElementById('filterColumn').value;
            const select = $('#filterValue'); 
            select.empty(); 
            if (!col) return;
            const uniqueValues = [...new Set(rawAssets.map(item => item[col] || "Unknown"))].sort();
            uniqueValues.forEach(val => select.append(new Option(val, val, false, false)));
            select.trigger('change');
        }

        function addFilter() {
            const colKey = document.getElementById('filterColumn').value;
            const colName = $('#filterColumn option:selected').text();
            const values = $('#filterValue').val();
            
            if (!colKey || !values || values.length === 0) { 
                Swal.fire("Incomplete", "Select a column and at least one value.", "warning"); return; 
            }

            if(!activeFilters[colKey]) {
                activeFilters[colKey] = { label: colName, values: [] };
            }
            const combined = new Set([...activeFilters[colKey].values, ...values]);
            activeFilters[colKey].values = Array.from(combined);

            applyGlobalFilters();
            renderChips();
            $('#filterValue').val(null).trigger('change');
        }

        function removeFilter(colKey) {
            delete activeFilters[colKey];
            applyGlobalFilters();
            renderChips();
        }

        function renderChips() {
            const container = document.getElementById('chipsContainer');
            const area = document.getElementById('activeFiltersArea');
            const keys = Object.keys(activeFilters);
            
            if(keys.length === 0) {
                area.style.display = 'none';
                return;
            }
            area.style.display = 'block';
            container.innerHTML = keys.map(col => {
                const f = activeFilters[col];
                const valText = f.values.join(', ');
                return `<span class="filter-chip"><b>${f.label}:</b> ${valText} <i class="fas fa-times-circle ms-2" onclick="removeFilter('${col}')"></i></span>`;
            }).join('');
        }

        function applyGlobalFilters() {
            const filterKeys = Object.keys(activeFilters);
            filteredData = rawAssets.filter(item => {
                return filterKeys.every(col => {
                    const allowedValues = activeFilters[col].values;
                    const itemValue = String(item[col] || "Unknown");
                    return allowedValues.includes(itemValue);
                });
            });
            refreshAllSections();
        }

        function initSectionStatusMenu(sectionKey, items) {
            const menu = $(`#filterMenu-${sectionKey}`); menu.empty();
            menu.append('<li><h6 class="dropdown-header">Show/Hide Statuses</h6></li><li><hr class="dropdown-divider"></li>');
            Array.from(items).sort().forEach(item => {
                menu.append(`<li><div class="form-check ms-3"><input class="form-check-input status-chk-${sectionKey}" type="checkbox" value="${item}" checked onchange="updateSectionFilter('${sectionKey}')"><label class="form-check-label small">${item}</label></div></li>`);
            });
        }

        function updateSectionFilter(sectionKey) {
            sections[sectionKey].statusFilter.clear();
            $(`.status-chk-${sectionKey}:checked`).each(function() { sections[sectionKey].statusFilter.add($(this).val()); });
            renderPivotSection(sectionKey);
        }

        function initOwnershipCategoryMenu(items) {
            const menu = $('#filterMenu-ownership'); menu.empty();
            menu.append('<li><h6 class="dropdown-header">Filter by Category</h6></li><li><hr class="dropdown-divider"></li>');
            Array.from(items).sort().forEach(item => {
                menu.append(`<li><div class="form-check ms-3"><input class="form-check-input cat-chk-ownership" type="checkbox" value="${item}" checked onchange="updateOwnershipCategoryFilter()"><label class="form-check-label small">${item}</label></div></li>`);
            });
        }

        function updateOwnershipCategoryFilter() {
            sections['ownership'].categoryFilter.clear();
            $('.cat-chk-ownership:checked').each(function() { sections['ownership'].categoryFilter.add($(this).val()); });
            renderOwnershipSection();
        }

        function refreshAllSections() {
            document.getElementById('recordCountDisplay').innerText = `Records: ${filteredData.length}`;
            ['year', 'location', 'brand', 'status'].forEach(key => renderPivotSection(key));
            renderOwnershipSection();
        }

        function toggleSectionView(key) {
            const tableDiv = document.getElementById(`table-${key}`);
            const chartDiv = document.getElementById(`chart-container-${key}`);
            if (tableDiv.style.display !== 'none') { tableDiv.style.display = 'none'; chartDiv.style.display = 'block'; }
            else { tableDiv.style.display = 'block'; chartDiv.style.display = 'none'; }
        }

        function renderPivotSection(key) {
            const config = sections[key];
            const tableId = `table-${key}`;
            const sectionData = filteredData.filter(item => config.statusFilter.has(item.status || "Unknown"));

            let rows = new Set(); let cols = new Set(); let matrix = {}; 
            sectionData.forEach(asset => {
                let r = asset[config.row] || "Unknown"; let c = asset[config.col] || "Uncategorized";
                rows.add(r); cols.add(c);
                if(!matrix[r]) matrix[r] = {}; if(!matrix[r][c]) matrix[r][c] = [];
                matrix[r][c].push(asset);
            });

            let sortedRows = Array.from(rows).sort(); if(key === 'year') sortedRows.reverse();
            let sortedCols = Array.from(cols).sort();

            let thead = `<tr><th class="row-header">${key.toUpperCase()} \\ Category</th>`;
            sortedCols.forEach(c => thead += `<th class="bg-secondary text-white">${c}</th>`);
            thead += `<th class="bg-dark text-white">Total</th></tr>`;
            $(`#${tableId} table thead`).html(thead);

            let tbody = '';
            sortedRows.forEach(r => {
                let rowTotal = 0; let rowHtml = `<tr><td class="row-header">${r}</td>`;
                sortedCols.forEach(c => {
                    let count = (matrix[r][c] || []).length; rowTotal += count;
                    if(count > 0) rowHtml += `<td onclick='showDetails("${key}", "${r}", "${c}")'><span class="count-badge">${count}</span></td>`;
                    else rowHtml += `<td class="text-muted">-</td>`;
                });
                rowHtml += `<td class="fw-bold bg-light border-start">${rowTotal}</td></tr>`; tbody += rowHtml;
            });
            $(`#${tableId} table tbody`).html(tbody);

            renderGenericChart(key, sortedRows, sortedCols, matrix);
        }

        function renderGenericChart(key, rows, cols, matrix) {
            const ctx = document.getElementById(`canvas-${key}`).getContext('2d');
            if (sections[key].chart) sections[key].chart.destroy();

            let datasets = cols.map((col, i) => {
                const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#6610f2'];
                return { label: col, data: rows.map(r => (matrix[r] && matrix[r][col]) ? matrix[r][col].length : 0), backgroundColor: colors[i % colors.length] };
            });

            sections[key].chart = new Chart(ctx, {
                type: 'bar', data: { labels: rows, datasets: datasets },
                plugins: [{
                    id: 'topLabels',
                    afterDatasetsDraw(chart) {
                        const { ctx, scales: { x, y } } = chart;
                        chart.data.labels.forEach((label, index) => {
                            let total = 0;
                            chart.data.datasets.forEach((ds) => total += ds.data[index]);
                            if (total > 0) {
                                const xPos = x.getPixelForValue(index);
                                const yPos = y.getPixelForValue(total);
                                ctx.save(); ctx.font = "bold 11px Arial"; ctx.fillStyle = "black"; ctx.textAlign = "center";
                                ctx.fillText(total, xPos, yPos - 5); ctx.restore();
                            }
                        });
                    }
                }],
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false }, 
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                    onClick: (e) => {
                        const chart = sections[key].chart;
                        const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const rowVal = chart.data.labels[firstPoint.index]; 
                            const colVal = chart.data.datasets[firstPoint.datasetIndex].label;
                            showDetails(key, rowVal, colVal);
                        }
                    },
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { footer: (items) => 'Total: ' + items.reduce((a, b) => a + b.parsed.y, 0) } } } 
                } 
            });
        }

        // --- OWNERSHIP LOGIC ---
        function renderOwnershipSection() {
            const catFilter = sections['ownership'].categoryFilter;
            let empCounts = {};
            
            rawEmployees.forEach(empObj => {
                const empNameClean = cleanName(empObj.name);
                const assets = filteredData.filter(asset => {
                    const assetUserClean = cleanName(asset.assignedTo);
                    const isNameMatch = assetUserClean === empNameClean;
                    const isStatusMatch = asset.status === 'In-Use';
                    const isCatMatch = catFilter.has(asset.category || "Uncategorized");
                    return isNameMatch && isStatusMatch && isCatMatch;
                });

                if (empObj.status === 'Active' || (empObj.status === 'Inactive' && assets.length > 0)) {
                    let isRisk = (empObj.status === 'Inactive' && assets.length > 0 && cleanName(empObj.type) === 'employee');
                    empCounts[empObj.name] = { count: assets.length, assets: assets, type: empObj.type, status: empObj.status, isRisk: isRisk };
                }
            });

            let buckets = { '0 Assets': [], '1 Asset': [], '2 Assets': [], '3 Assets': [], '4 Assets': [], '5+ Assets': [] };
            Object.keys(empCounts).forEach(name => {
                const data = empCounts[name];
                const count = data.count;
                let bucketName = count === 0 ? '0 Assets' : count === 1 ? '1 Asset' : count <= 4 ? `${count} Assets` : '5+ Assets';
                if (!buckets[bucketName]) buckets[bucketName] = []; 
                buckets[bucketName].push({ name, ...data });
            });

            $('#stat-zero').text(buckets['0 Assets'].length);
            $('#stat-one').text(buckets['1 Asset'].length);
            const multiCount = (buckets['2 Assets'] ? buckets['2 Assets'].length : 0) + (buckets['3 Assets'] ? buckets['3 Assets'].length : 0) + (buckets['4 Assets'] ? buckets['4 Assets'].length : 0);
            $('#stat-multi').text(multiCount);
            $('#stat-hoard').text(buckets['5+ Assets'].length);

            let tbody = '';
            Object.keys(buckets).forEach(b => {
                const users = buckets[b];
                const count = users.length;
                const empCount = users.filter(u => cleanName(u.type) === 'employee').length;
                const otherCount = users.filter(u => cleanName(u.type) !== 'employee').length;
                let btnHtml = count > 0 ? `<button class="btn btn-sm btn-outline-info" onclick='showUserList("${b}")'>View List</button>` : '-';
                tbody += `<tr><td class="fw-bold">${b}</td><td><span class="badge bg-dark fs-6">${count}</span></td><td class="text-success fw-bold">${empCount}</td><td class="text-info fw-bold">${otherCount}</td><td>${btnHtml}</td></tr>`;
                sections['ownership'].buckets[b] = buckets[b];
            });
            $('#ownershipBody').html(tbody);

            const ctx = document.getElementById(`canvas-ownership`).getContext('2d');
            if (sections['ownership'].chart) sections['ownership'].chart.destroy();
            const labels = Object.keys(buckets);
            const data = labels.map(k => buckets[k].length);
            sections['ownership'].chart = new Chart(ctx, {
                type: 'bar', data: { labels: labels, datasets: [{ label: 'Employee Count', data: data, backgroundColor: ['#e74a3b', '#1cc88a', '#f6c23e', '#fd7e14', '#fd7e14', '#4e73df'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function showDetails(sectionKey, rowVal, colVal) {
            const config = sections[sectionKey];
            let list = filteredData.filter(asset => config.statusFilter.has(asset.status || "Unknown") && String(asset[config.row] || "Unknown") === String(rowVal) && String(asset[config.col] || "Uncategorized") === String(colVal));
            $('#modalTitle').html(`<i class="fas fa-list me-2"></i> ${rowVal} - ${colVal} (${list.length})`);
            let html = list.map(asset => `<tr><td class="fw-bold text-primary">${asset.id}</td><td>${asset.serial}</td><td>${asset.category}</td><td>${asset.brand} ${asset.model}</td><td>${asset.location}</td><td>${asset.assignedTo || '-'}</td><td>${asset.status}</td></tr>`).join('');
            $('#detailBody').html(html);
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        function showUserList(bucketKey) {
            currentModalData = sections['ownership'].buckets[bucketKey]; 
            $('#userListTitle').text(`${bucketKey} - ${currentModalData.length} Employees`);
            $('#modalFilterType').val('All'); $('#modalFilterStatus').val('All');
            renderUserListTable(currentModalData);
            new bootstrap.Modal(document.getElementById('userListModal')).show();
        }

        function filterUserList() {
            const typeFilter = cleanName($('#modalFilterType').val());
            const statusFilter = cleanName($('#modalFilterStatus').val());
            const filteredList = currentModalData.filter(u => {
                const matchType = typeFilter === 'all' || cleanName(u.type) === typeFilter;
                const matchStatus = statusFilter === 'all' || cleanName(u.status) === statusFilter;
                return matchType && matchStatus;
            });
            renderUserListTable(filteredList);
        }

        function renderUserListTable(data) {
            let html = data.map(u => {
                const assetBadges = u.assets.map(a => `<span class="badge asset-badge-btn me-1 mb-1" onclick="viewSpecificAsset('${a.id}')">${a.category} <i class="fas fa-info-circle ms-1"></i></span>`).join('');
                let rowClass = u.isRisk ? 'row-risk' : '';
                return `<tr class="${rowClass}"><td><div class="fw-bold text-primary">${u.name}</div></td><td>${u.type}</td><td>${u.status}</td><td class="text-center fw-bold">${u.count}</td><td>${assetBadges || '<span class="text-muted">None</span>'}</td></tr>`;
            }).join('');
            $('#userListBody').html(html || '<tr><td colspan="5" class="text-center">No matching records</td></tr>');
        }

        function viewSpecificAsset(assetId) {
            const asset = rawAssets.find(a => a.id === assetId);
            if(!asset) return;
            const html = `<tr><th class="bg-light w-25">Asset ID</th><td class="fw-bold text-primary">${asset.id}</td></tr><tr><th class="bg-light">Serial No</th><td>${asset.serial || '-'}</td></tr><tr><th class="bg-light">Category</th><td>${asset.category}</td></tr><tr><th class="bg-light">Brand / Model</th><td>${asset.brand} / ${asset.model}</td></tr><tr><th class="bg-light">Location</th><td>${asset.location}</td></tr><tr><th class="bg-light">Allocated To</th><td>${asset.assignedTo}</td></tr><tr><th class="bg-light">Status</th><td><span class="badge bg-secondary">${asset.status}</span></td></tr><tr><th class="bg-light">Remarks</th><td>${asset.remarks || 'None'}</td></tr>`;
            $('#singleAssetBody').html(html);
            new bootstrap.Modal(document.getElementById('singleAssetModal')).show();
        }

        function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>

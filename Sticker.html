<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Sticker Station - Gretex ERP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        body { background-color: #f4f6f9; }
        
        /* Sidebar */
        .sidebar {
            height: 100vh;
            background: #2c3e50;
            color: white;
            position: fixed;
            width: 250px;
            padding-top: 20px;
            z-index: 1000;
        }
        .sidebar a {
            color: #b0b8c5;
            text-decoration: none;
            display: block;
            padding: 12px 20px;
            transition: 0.3s;
        }
        . a:hover, . a.active {
            background: #34495e;
            color: white;
            border-left: 4px solid #3498db;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .card-custom {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        /* --- STICKER CARD DESIGN --- */
        .sticker-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .sticker-card {
            width: 340px;
            height: 170px;
            background: white;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Left Side: Info */
        .sticker-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .sticker-id {
            font-size: 24px;
            font-weight: 800;
            color: #000;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .sticker-meta {
            font-size: 11px;
            color: #333;
            line-height: 1.5;
            font-weight: 600;
        }

        .sticker-meta span {
            font-weight: 400;
            color: #555;
            margin-left: 4px;
        }

        .sticker-footer {
            margin-top: auto;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            font-weight: bold;
            border-top: 1px solid #ddd;
            padding-top: 5px;
            width: 90%;
        }

        /* Right Side: QR & Label */
        .sticker-qr-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100px;
            border-left: 1px dashed #ccc;
            padding-left: 10px;
            margin-left: 10px;
        }

        .sticker-qr img {
            width: 85px;
            height: 85px;
            mix-blend-mode: multiply;
        }

        .sticker-badge {
            background: #000;
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            margin-top: 5px;
            text-transform: uppercase;
        }

        /* --- FIXED PRINT SETTINGS (GRID LAYOUT) --- */
        @media print {
            /* 1. Hide specific UI elements */
            .sidebar, .card-custom, .d-flex, .nav, .modal, .btn, .header-title, .select2-container, h5, .swal2-container {
                display: none !important;
            }

            /* 2. Reset Body properties */
            body, .main-content {
                background-color: white !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                visibility: visible !important;
            }

            /* 3. Position and Format the Printable Section */
            #printableSection {
                display: grid !important;
                grid-template-columns: 1fr 1fr; /* 2 Stickers per row */
                gap: 15px; /* Space between stickers */
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                padding: 10px;
                visibility: visible !important;
            }

            /* 4. Ensure contents are visible */
            #printableSection * {
                visibility: visible !important;
            }

            #stickerPreviewArea {
                display: contents; /* Allows grid to apply to children */
            }

            .sticker-card {
                width: 100% !important;
                box-shadow: none !important;
                border: 2px solid #000 !important;
                break-inside: avoid; /* Don't cut stickers in half */
                page-break-inside: avoid;
                margin: 0 !important;
            }

            .sticker-badge {
                background: #000 !important;
                color: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

    <div class="sidebar">
            <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
            <a href="Emp.html"><i class="fas fa-user-plus"></i> Add Employee</a>
            <a href="asset.html"><i class="fas fa-laptop-medical"></i> Add Asset</a>
            <a href="allocate.html"><i class="fas fa-hand-holding"></i> Allocate Asset</a>
            <a href="Return.html"><i class="fas fa-undo"></i> Return Asset</a>
            <a href="Shift.html"><i class="fas fa-truck-moving"></i> Shift Asset</a>
            <a href="Sticker.html" class="active"><i class="fas fa-tags"></i> Create Sticker</a>
            <a href="StockQC.html"><i class="fas fa-clipboard-check"></i> Stock QC</a>
            <a href="ITChecklist.html"><i class="fas fa-tasks"></i> IT Checklist</a>
            <a href="stock.html"><i class="fas fa-exchange-alt"></i> Stock In/Out</a>
            <a href="data.html"><i class="fas fa-database"></i> Import / Export</a>
     </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="header-title">Smart Sticker Station</h3>
        </div>

        <div class="card card-custom p-4 mb-4">
            <h5 class="mb-3">Select Asset (Pending Only)</h5>
            <div class="row g-2 align-items-end">
                <div class="col-md-9">
                    <label class="form-label text-muted small">Search by Asset ID or Name</label>
                    <select class="form-select" id="assetSelect">
                        <option value="">Loading Assets...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-warning w-100 fw-bold" onclick="openConfigModal()">
                        <i class="fas fa-cart-plus me-2"></i>Add to Queue
                    </button>
                </div>
            </div>
        </div>

        <div class="card card-custom p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0">Sticker Queue</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="loadQueue()">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>

            <div class="table-responsive" style="max-height: 200px; overflow-y:auto;">
                <table class="table queue-table align-middle table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Asset ID</th>
                            <th>Category</th>
                            <th>Label</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="queueTableBody">
                        <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end gap-3 mt-3 border-top pt-3">
                <button class="btn btn-dark px-4" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Step 1: Print Stickers
                </button>
                <button class="btn btn-success px-4" id="btnMarkDone" onclick="markAsDone()" disabled>
                    <i class="fas fa-check-circle me-2"></i>Step 2: Mark as Done
                </button>
            </div>
        </div>

        <div id="printableSection">
            <h5 class="mb-3 text-secondary d-print-none"><i class="fas fa-eye me-2"></i>Live Print Preview</h5>
            <div id="stickerPreviewArea" class="sticker-container">
                </div>
        </div>

    </div>

    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Configure Stickers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalAssetId">
                    <input type="hidden" id="modalAssetName">
                    <p class="fw-bold mb-3 text-primary" id="modalAssetDisplay">Selected: None</p>

                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="stickerQty" class="form-control" value="1" min="1" onchange="renderStickerInputs()">
                    </div>

                    <div id="stickerInputContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-dark" onclick="confirmAndAddStickers()">Confirm & Add</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ðŸ‘‡ðŸ‘‡ðŸ‘‡ REPLACE WITH YOUR GAS SCRIPT URL ðŸ‘‡ðŸ‘‡ðŸ‘‡
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypAYvqG8Lw5-tVd-JaE4PNc6FEzkTRsEBr36uqGwA92wTxxMAOAgV9xeW9QPm4Q-0V2w/exec"; 

        // ðŸ‘‡ðŸ‘‡ðŸ‘‡ YOUR SCAN PAGE URL (User ne diya) ðŸ‘‡ðŸ‘‡ðŸ‘‡
        const SCAN_BASE_URL = "https://anup930.github.io/Inventory_Gretex_App/scan.html";

        const STICKER_TYPES = ["Laptop", "Desktop", "Charger", "Keyboard", "Mouse", "Monitor", "Bag", "Main Asset", "Other"];
        const DEFAULT_SEQUENCE = ["Laptop", "Charger", "Keyboard", "Mouse", "Bag"]; 

        $(document).ready(function() {
            // Select2 init
            $('#assetSelect').select2({ 
                theme: 'bootstrap-5', 
                width: '100%',
                placeholder: "-- Search Pending Asset --"
            });

            loadPendingAssets();
            loadQueue();
            
            document.getElementById('stickerQty').addEventListener('input', renderStickerInputs);
            window.addEventListener("afterprint", () => {
                document.getElementById('btnMarkDone').disabled = false;
            });
        });

        // 1. LOAD QUEUE & GENERATE LINKED QR CODES
        function loadQueue() {
            const tbody = document.getElementById('queueTableBody');
            const previewArea = document.getElementById('stickerPreviewArea');
            
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">Refreshing...</td></tr>';
            previewArea.innerHTML = '<div class="text-muted p-3">Loading Preview...</div>';

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getStickerQueue" })
            })
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = '';
                previewArea.innerHTML = '';

                if(data.status === "success" && data.queue.length > 0) {
                    
                    data.queue.forEach(item => {
                        // A. Table Row
                        tbody.innerHTML += `
                            <tr>
                                <td class="fw-bold">${item.id}</td>
                                <td>${item.category || '-'}</td>
                                <td><span class="badge bg-info text-dark">${item.label}</span></td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${item.rowIndex})"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>`;

                        // B. QR CODE LINK GENERATION (Crucial Step)
                        const qrLink = `${SCAN_BASE_URL}?id=${item.id}`;
                        const qrData = encodeURIComponent(qrLink);
                        const qrUrl = `https://quickchart.io/qr?text=${qrData}&size=160&margin=1`;

                        // C. Sticker Design
                        const stickerHTML = `
                            <div class="sticker-card">
                                <div class="sticker-info">
                                    <div class="sticker-id">${item.id}</div>
                                    <div class="sticker-meta">
                                        <div>S/N: <span>${item.serial || 'N/A'}</span></div>
                                        <div>Model: <span>${item.brand} ${item.model}</span></div>
                                        <div>Config: <span>${item.config || '-'}</span></div>
                                        </div>
                                    <div class="sticker-footer">Property of Gretex</div>
                                </div>
                                <div class="sticker-qr-section">
                                    <div class="sticker-qr">
                                        <img src="${qrUrl}" alt="Scan to View">
                                    </div>
                                    <div class="sticker-badge">${item.label}</div>
                                </div>
                            </div>
                        `;
                        previewArea.innerHTML += stickerHTML;
                    });

                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Queue is empty</td></tr>';
                    previewArea.innerHTML = '<div class="text-muted p-3"><i>Add assets to see sticker preview.</i></div>';
                }
            });
        }

        // 2. LOAD ASSETS
        function loadPendingAssets() {
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "getPendingAssets" }) })
            .then(res => res.json())
            .then(data => {
                const select = $('#assetSelect');
                select.empty();
                select.append('<option value="">-- Select Asset --</option>');
                
                if(data.status === "success") {
                    data.assets.forEach(asset => {
                        select.append(new Option(asset.name, asset.id));
                    });
                }
                select.trigger('change'); 
            });
        }

        // 3. HELPERS
        function openConfigModal() {
            const assetId = $('#assetSelect').val();
            if (!assetId) { Swal.fire("Wait!", "Select an asset first.", "warning"); return; }
            document.getElementById('modalAssetId').value = assetId;
            document.getElementById('modalAssetName').value = $('#assetSelect option:selected').text();
            document.getElementById('modalAssetDisplay').innerText = "Selected: " + $('#assetSelect option:selected').text();
            document.getElementById('stickerQty').value = 1;
            renderStickerInputs();
            new bootstrap.Modal(document.getElementById('configModal')).show();
        }

        function renderStickerInputs() {
            const count = Math.max(1, parseInt(document.getElementById('stickerQty').value) || 1);
            const container = document.getElementById('stickerInputContainer');
            container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = "input-group mb-2";
                const select = document.createElement('select');
                select.className = "form-select sticker-label-input";
                STICKER_TYPES.forEach(t => select.add(new Option(t, t)));
                select.value = (i < DEFAULT_SEQUENCE.length) ? DEFAULT_SEQUENCE[i] : "Other";
                div.innerHTML = `<span class="input-group-text">Sticker ${i+1}</span>`;
                div.appendChild(select);
                container.appendChild(div);
            }
        }

        function confirmAndAddStickers() {
            const inputs = document.querySelectorAll('.sticker-label-input');
            const labels = Array.from(inputs).map(i => i.value);
            const assetId = document.getElementById('modalAssetId').value;
            const assetName = document.getElementById('modalAssetName').value;
            const btn = document.querySelector('#configModal .btn-dark');
            btn.innerText = "Adding..."; btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "addToStickerQueue", assetId, assetName, labels, user: "Admin" })
            }).then(() => {
                bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
                btn.innerText = "Confirm & Add"; btn.disabled = false;
                loadQueue();
            });
        }

        function deleteItem(rowIndex) {
            if(!confirm("Remove sticker?")) return;
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "deleteFromQueue", rowIndex }) })
            .then(() => loadQueue());
        }

        function markAsDone() {
            Swal.fire({
                title: "Mark as Printed?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Yes, Completed"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "markStickersGenerated" }) })
                    .then(() => { 
                        Swal.fire("Success", "Updated", "success"); 
                        loadQueue(); 
                        loadPendingAssets(); 
                        document.getElementById('btnMarkDone').disabled = true;
                    });
                }
            });
        }
    </script>
</body>
</html>

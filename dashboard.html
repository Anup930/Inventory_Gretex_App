<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gretex ERP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #222e3c; color: white; padding-top: 20px; z-index: 1000; }
        .sidebar-header { text-align: center; margin-bottom: 30px; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #34495e; padding-bottom: 20px; }
        .sidebar a { color: #aab8c5; padding: 12px 25px; display: flex; align-items: center; text-decoration: none; transition: 0.3s; font-size: 0.95rem; }
        .sidebar a i { width: 25px; text-align: center; margin-right: 10px; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid #4e73df; }
        .main-content { margin-left: 250px; padding: 30px; }
        
        /* CLICKABLE CARDS */
        .stat-card { 
            background: white; border-radius: 12px; padding: 25px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.3s; 
            border-left: 5px solid #ccc; cursor: pointer; position: relative; overflow: hidden;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .stat-card h2 { font-weight: bold; margin: 10px 0 0 0; color: #333; }
        
        .alert-card { border-left: 5px solid #e74a3b !important; background: #fff5f5; }
        .alert-card:hover { background: #fee2e2; }

        #hoverChartCard { display: none; position: absolute; z-index: 9999; width: 280px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); pointer-events: none; border: 1px solid rgba(0,0,0,0.1); }
        
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .table-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; margin-top: 0; }
        .pivot-table th { background-color: #e2e6ea; font-size: 0.85rem; text-transform: uppercase; border: 1px solid #dee2e6; }
        .pivot-table td { font-size: 0.9rem; border: 1px solid #dee2e6; }
        .fw-bold-total { font-weight: 700; background-color: #d1d3e2 !important; }
    </style>
    <script>
        const user = JSON.parse(sessionStorage.getItem("user"));
        if (!user) window.location.href = "index.html";
    </script>
</head>
<body>

    <div class="sidebar">
        <h4 class="text-center mb-4"><i class="fas fa-warehouse"></i> Gretex ERP</h4>
        <a href="dashboard.html" class="active"><i class="fas fa-home"></i> Dashboard</a>
        <a href="Emp.html"><i class="fas fa-user-plus"></i> Add Employee</a>
        <a href="asset.html"><i class="fas fa-laptop-medical"></i> Add Asset</a>
        <a href="allocate.html"><i class="fas fa-hand-holding"></i> Allocate Asset</a>
        <a href="Return.html"><i class="fas fa-undo"></i> Return Asset</a>
        <a href="AssetHistory.html"><i class="fas fa-history"></i> Asset History</a>
        <a href="EmpHistory.html"><i class="fas fa-user-clock"></i> Emp History</a>
        <a href="Repair.html"><i class="fas fa-tools"></i> Maintenance</a>
        <a href="stock.html"><i class="fas fa-exchange-alt"></i> Stock In/Out</a>
        <a href="data.html"><i class="fas fa-database"></i> Import / Export</a>
        <div style="margin-top: 40px; border-top: 1px solid #3e4b5b;"></div>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h3 class="fw-bold text-dark m-0">Analytics Dashboard</h3><small class="text-muted">Live Inventory Status</small></div>
            <div class="bg-white px-3 py-2 rounded shadow-sm"><i class="fas fa-user-circle text-primary me-2"></i><span class="fw-bold" id="userNameDisplay">User</span></div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col">
                <div class="stat-card" style="border-left-color: #4e73df;" onmouseenter="showBreakdown(this, 'total')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-primary"><i class="fas fa-laptop"></i></div><p class="text-primary">Total Assets</p><h2 id="totalAssets">0</h2>
                </div>
            </div>
            <div class="col">
                <div class="stat-card" style="border-left-color: #1cc88a;" onclick="showAvailableModal()" onmouseenter="showBreakdown(this, 'available')" onmouseleave="hideBreakdown()" title="Click to view Stock List">
                    <div class="icon-box text-success"><i class="fas fa-check-circle"></i></div><p class="text-success">Available</p><h2 id="totalAvailable">0</h2>
                </div>
            </div>
            <div class="col">
                <div class="stat-card" style="border-left-color: #f6c23e;" onmouseenter="showBreakdown(this, 'allocated')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-warning"><i class="fas fa-user-check"></i></div><p class="text-warning">Allocated</p><h2 id="totalAllocated">0</h2>
                </div>
            </div>
            <div class="col">
                <div class="stat-card" style="border-left-color: #858796;" onmouseenter="showBreakdown(this, 'repair')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-secondary"><i class="fas fa-tools"></i></div><p class="text-secondary">Maintenance</p><h2 id="totalRepair">0</h2>
                </div>
            </div>
            <div class="col">
                <div class="stat-card alert-card" onclick="showInactiveModal()" title="Click to View Details">
                    <div class="icon-box text-danger"><i class="fas fa-exclamation-triangle"></i></div><p class="text-danger fw-bold">Assets with Inactive Emp</p><h2 id="totalInactiveAssets">0</h2>
                </div>
            </div>
        </div>

        <div id="hoverChartCard" class="card">
            <div class="card-body p-2">
                <h6 class="text-center small fw-bold text-muted mb-2 border-bottom pb-1" id="hoverChartTitle">Breakdown</h6>
                <div style="height: 180px;"><canvas id="hoverChartCanvas"></canvas></div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-8"><div class="chart-box"><h6 class="text-muted mb-3 fw-bold">Location-wise Asset Status</h6><div class="chart-wrapper"><canvas id="locationChart"></canvas></div></div></div>
            <div class="col-md-4"><div class="chart-box"><h6 class="text-muted mb-3 fw-bold">Assets per Employee</h6><div class="chart-wrapper"><canvas id="ownershipChart"></canvas></div></div></div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6"><div class="chart-box"><h6 class="text-muted mb-3 fw-bold">Category Distribution</h6><div class="chart-wrapper"><canvas id="categoryChart"></canvas></div></div></div>
            <div class="col-md-6"><div class="chart-box"><h6 class="text-muted mb-3 fw-bold">Brand Distribution</h6><div class="chart-wrapper"><canvas id="brandChart"></canvas></div></div></div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="chart-box">
                    <h6 class="text-muted mb-3 fw-bold">Overall Asset Status Distribution <span class="badge bg-info text-dark ms-2">Click Bars to View Data</span></h6>
                    <div class="chart-wrapper" style="height: 250px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <h5 class="text-dark mb-3 fw-bold"><i class="fas fa-table me-2"></i>Location vs Status Summary</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover pivot-table text-center align-middle" id="pivotTable">
                            <thead class="table-light"><tr><th>Loading...</th></tr></thead><tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="statusDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="statusModalTitle">Asset Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-8"><input type="text" id="statusSearch" class="form-control" placeholder="Search..." onkeyup="filterStatusTable()"></div>
                        <div class="col-md-4 text-end"><button onclick="downloadStatusReport()" class="btn btn-dark w-100"><i class="fas fa-download me-2"></i>Download List</button></div>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-bordered table-hover text-center align-middle">
                            <thead class="table-light sticky-top" id="statusTableHead">
                                </thead>
                            <tbody id="statusTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="inactiveModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Assets with Inactive Employees</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-end mb-2">
                        <button onclick="downloadInactiveReport()" class="btn btn-sm btn-success"><i class="fas fa-download me-2"></i>Download CSV</button>
                    </div>
                    <div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Asset ID</th><th>Serial No</th><th>Type</th><th>Assigned To</th><th>Emp ID</th></tr></thead><tbody id="inactiveTableBody"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="availableModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-boxes me-2"></i>Available Stock Inventory</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-8"><input type="text" id="availableSearch" class="form-control" placeholder="Search..." onkeyup="filterAvailableTable()"></div>
                        <div class="col-md-4 text-end"><button onclick="downloadAvailableReport()" class="btn btn-primary w-100"><i class="fas fa-download me-2"></i>Export Stock List</button></div>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-bordered table-hover text-center align-middle">
                            <thead class="table-light sticky-top"><tr><th>Asset ID</th><th>Serial No</th><th>Category</th><th>Brand / Type</th><th>Location</th></tr></thead>
                            <tbody id="availableTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = "YOUR_DEPLOYED_GAS_URL_HERE"; 
        document.getElementById("userNameDisplay").innerText = user.name;

        let locChartInstance = null, ownChartInstance = null, catChartInstance = null, brandChartInstance = null, hoverChartInstance = null, statusChartInstance = null;
        let breakdownData = { total: {}, available: {}, allocated: {}, repair: {} };
        
        let inactiveAssetsList = []; 
        let availableAssetsList = []; 
        let allAssetRows = []; // For filtering on chart click
        let currentStatusList = []; // Currently viewing in modal

        async function loadData() {
            try {
                const assetReq = fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "exportData", sheetName: "Asset_Master" }) });
                const empReq = fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "exportData", sheetName: "Employees" }) });
                const [assetRes, empRes] = await Promise.all([assetReq, empReq].map(p => p.then(r => r.json())));

                if (assetRes.status === "success" && empRes.status === "success") {
                    processDashboard(assetRes.data, empRes.data);
                }
            } catch (error) { console.error("Error:", error); }
        }

        function processDashboard(assetData, empData) {
            const empHeaders = empData[0];
            const empRows = empData.slice(1);
            const getEmpIdx = (name) => empHeaders.findIndex(h => h.toString().toLowerCase().includes(name.toLowerCase()));
            const EMP_NAME = getEmpIdx("Name");
            const EMP_STATUS = getEmpIdx("Status");
            const EMP_ID = getEmpIdx("ID"); 

            const inactiveEmpMap = {};
            empRows.forEach(row => {
                const status = (row[EMP_STATUS] || "").toString().trim();
                if(status === 'Inactive') inactiveEmpMap[row[EMP_NAME].toString().toLowerCase()] = row[EMP_ID] || "N/A";
            });

            const headers = assetData[0]; 
            const rows = assetData.slice(1);
            
            // SAVE RAW ROWS FOR MODAL FILTERING
            allAssetRows = rows.map(r => {
                return {
                    id: r[getIdx(headers, "AssetID")],
                    serial: r[getIdx(headers, "Serial")],
                    loc: r[getIdx(headers, "Location")],
                    user: r[getIdx(headers, "Assigned")],
                    status: r[getIdx(headers, "Status")],
                    cat: r[getIdx(headers, "Category")],
                    brand: r[getIdx(headers, "Brand")]
                };
            });

            const IDX_LOC = getIdx(headers, "Location");
            const IDX_CAT = getIdx(headers, "Category");
            const IDX_BRAND = getIdx(headers, "Brand");
            const IDX_STATUS = getIdx(headers, "Status");
            const IDX_USER = getIdx(headers, "Assigned");

            let total = 0, available = 0, allocated = 0, repair = 0;
            const locationMap = {}, categoryMap = {}, brandMap = {}, userAssetCounts = {}, statusMap = {};
            const allStatuses = new Set();
            inactiveAssetsList = [];
            availableAssetsList = [];

            rows.forEach(r => {
                const loc = (r[IDX_LOC] || "Unknown").toString().trim();
                const status = (r[IDX_STATUS] || "Unknown").toString().trim();
                const user = (r[IDX_USER] || "Unassigned").toString().trim();
                const cat = (r[IDX_CAT] || "Unknown").toString().trim();
                const brand = (r[IDX_BRAND] || "Unknown").toString().trim();

                if(loc === "") return;

                total++;
                breakdownData.total[cat] = (breakdownData.total[cat] || 0) + 1;
                statusMap[status] = (statusMap[status] || 0) + 1;

                if(status === 'Available') {
                    available++;
                    breakdownData.available[cat] = (breakdownData.available[cat] || 0) + 1;
                    availableAssetsList.push({ id: r[getIdx(headers, "AssetID")], serial: r[getIdx(headers, "Serial")], cat: cat, brand: brand, loc: loc });
                } else if(status === 'In-Use') {
                    allocated++;
                    breakdownData.allocated[cat] = (breakdownData.allocated[cat] || 0) + 1;
                    const userLower = user.toLowerCase();
                    for (const [inactiveName, empId] of Object.entries(inactiveEmpMap)) {
                        if (userLower.includes(inactiveName)) {
                            inactiveAssetsList.push({ assetId: r[getIdx(headers, "AssetID")], serial: r[getIdx(headers, "Serial")], type: cat, user: user, empId: empId });
                            break;
                        }
                    }
                } else if(['Repair', 'Damaged', 'Scrap'].includes(status)) {
                    repair++;
                    breakdownData.repair[cat] = (breakdownData.repair[cat] || 0) + 1;
                }

                allStatuses.add(status);
                if (!locationMap[loc]) locationMap[loc] = {}; locationMap[loc][status] = (locationMap[loc][status] || 0) + 1;
                if (!categoryMap[cat]) categoryMap[cat] = {}; categoryMap[cat][status] = (categoryMap[cat][status] || 0) + 1;
                if (!brandMap[brand]) brandMap[brand] = {}; brandMap[brand][status] = (brandMap[brand][status] || 0) + 1;
                if(status === 'In-Use' && user !== "Unassigned") userAssetCounts[user] = (userAssetCounts[user] || 0) + 1;
            });

            document.getElementById("totalAssets").innerText = total;
            document.getElementById("totalAvailable").innerText = available;
            document.getElementById("totalAllocated").innerText = allocated;
            document.getElementById("totalRepair").innerText = repair;
            document.getElementById("totalInactiveAssets").innerText = inactiveAssetsList.length;

            renderPivotTable(locationMap, Array.from(allStatuses).sort());
            renderStackedChart('locationChart', locationMap, Array.from(allStatuses).sort(), locChartInstance, (i) => locChartInstance = i);
            renderOwnershipChart(Object.values(userAssetCounts).reduce((acc, c) => { acc[c+(c===1?" Device":" Devices")] = (acc[c+(c===1?" Device":" Devices")]||0)+1; return acc; }, {}));
            renderStackedChart('categoryChart', categoryMap, Array.from(allStatuses).sort(), catChartInstance, (i) => catChartInstance = i);
            renderStackedChart('brandChart', brandMap, Array.from(allStatuses).sort(), brandChartInstance, (i) => brandChartInstance = i);
            renderStatusChart(statusMap);
        }

        // --- HELPER: GET COLUMN INDEX BY NAME ---
        function getIdx(headers, name) {
            return headers.findIndex(h => h.toString().toLowerCase().includes(name.toLowerCase()));
        }

        // --- STATUS CHART WITH CLICK EVENT ---
        function renderStatusChart(map) {
            const ctx = document.getElementById("statusChart").getContext("2d");
            if(statusChartInstance) statusChartInstance.destroy();
            const labels = Object.keys(map);
            const data = Object.values(map);
            const colors = ['#1cc88a', '#f6c23e', '#e74a3b', '#4e73df', '#858796', '#36b9cc', '#20c9a6', '#6610f2'];

            statusChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Count', data: data, backgroundColor: colors, borderRadius: 5 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } },
                    onClick: (evt, activeEls) => {
                        if (activeEls.length > 0) {
                            const index = activeEls[0].index;
                            const status = labels[index];
                            openStatusModal(status);
                        }
                    }
                }
            });
        }

        // --- OPEN STATUS DETAIL MODAL ---
        function openStatusModal(status) {
            document.getElementById("statusModalTitle").innerText = `Details: ${status} Assets`;
            
            // Filter Data
            currentStatusList = allAssetRows.filter(r => r.status === status);
            
            // Define Headers
            const thead = document.getElementById("statusTableHead");
            if(status === 'In-Use') {
                thead.innerHTML = `<tr><th>Asset ID</th><th>Serial No</th><th>Location</th><th>Assigned To</th><th>Category</th></tr>`;
            } else {
                thead.innerHTML = `<tr><th>Asset ID</th><th>Serial No</th><th>Location</th><th>Category</th><th>Asset Type / Brand</th></tr>`;
            }

            renderStatusTable(currentStatusList, status);
            new bootstrap.Modal(document.getElementById('statusDetailModal')).show();
        }

        function renderStatusTable(data, status) {
            const tbody = document.getElementById("statusTableBody");
            tbody.innerHTML = "";
            if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='5'>No Data</td></tr>"; return; }

            data.forEach(item => {
                if(status === 'In-Use') {
                    tbody.innerHTML += `<tr><td class="fw-bold">${item.id}</td><td>${item.serial}</td><td>${item.loc}</td><td class="text-primary fw-bold">${item.user}</td><td>${item.cat}</td></tr>`;
                } else {
                    tbody.innerHTML += `<tr><td class="fw-bold">${item.id}</td><td>${item.serial}</td><td>${item.loc}</td><td>${item.cat}</td><td>${item.brand}</td></tr>`;
                }
            });
        }

        function filterStatusTable() {
            const input = document.getElementById("statusSearch").value.toLowerCase();
            const filtered = currentStatusList.filter(item => 
                Object.values(item).some(val => val.toString().toLowerCase().includes(input))
            );
            // Get current title to determine layout (In-Use vs Others)
            const title = document.getElementById("statusModalTitle").innerText;
            const isInUse = title.includes("In-Use");
            renderStatusTable(filtered, isInUse ? 'In-Use' : 'Other');
        }

        function downloadStatusReport() {
            if(currentStatusList.length === 0) return;
            const csv = Papa.unparse(currentStatusList);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Status_Report.csv`; link.click();
        }

        // --- OTHER MODALS & CHARTS (Keeping Existing Logic) ---
        function showAvailableModal() { renderAvailableTable(availableAssetsList); new bootstrap.Modal(document.getElementById('availableModal')).show(); }
        function filterAvailableTable() { const input = document.getElementById("availableSearch").value.toLowerCase(); renderAvailableTable(availableAssetsList.filter(i => (i.id+i.serial+i.cat+i.brand+i.loc).toLowerCase().includes(input))); }
        function renderAvailableTable(data) { document.getElementById("availableTableBody").innerHTML = data.map(i => `<tr><td class="fw-bold text-primary">${i.id}</td><td>${i.serial}</td><td><span class="badge bg-info text-dark">${i.cat}</span></td><td>${i.brand}</td><td>${i.loc}</td></tr>`).join('') || "<tr><td colspan='5'>No Data</td></tr>"; }
        function downloadAvailableReport() { const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([Papa.unparse(availableAssetsList)], { type: 'text/csv' })); link.download = "Available_Stock.csv"; link.click(); }

        function showInactiveModal() { 
            const b = document.getElementById("inactiveTableBody"); b.innerHTML = inactiveAssetsList.length ? inactiveAssetsList.map(i => `<tr><td class="fw-bold text-danger">${i.assetId}</td><td>${i.serial}</td><td>${i.type}</td><td>${i.user}</td><td>${i.empId}</td></tr>`).join('') : "<tr><td colspan='5' class='text-center text-success fw-bold'>All Clear!</td></tr>"; 
            new bootstrap.Modal(document.getElementById('inactiveModal')).show(); 
        }
        function downloadInactiveReport() { const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([Papa.unparse(inactiveAssetsList)], { type: 'text/csv' })); link.download = "Inactive_Risk.csv"; link.click(); }

        // Renderers
        function showBreakdown(el, type) { /* Standard hover logic */ const p=document.getElementById("hoverChartCard"); const r=el.getBoundingClientRect(); p.style.display="block"; p.style.top=(r.top+window.scrollY+10)+"px"; p.style.left=(r.left+r.width-20)+"px"; document.getElementById("hoverChartTitle").innerText=type.toUpperCase()+" Breakdown"; const d=breakdownData[type], l=Object.keys(d), v=Object.values(d); if(!l.length){l.push("No Data");v.push(1);} const c=document.getElementById("hoverChartCanvas").getContext("2d"); if(hoverChartInstance)hoverChartInstance.destroy(); hoverChartInstance=new Chart(c,{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:['#4e73df','#1cc88a','#36b9cc','#f6c23e']}]},options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},plugins:{legend:{position:'right',labels:{boxWidth:10,font:{size:10}}}}}}); }
        function hideBreakdown() { document.getElementById("hoverChartCard").style.display="none"; }
        
        function renderStackedChart(id, map, stats, inst, setInst) { const c=document.getElementById(id).getContext('2d'), l=Object.keys(map).sort(); if(inst) inst.destroy(); setInst(new Chart(c, { type: 'bar', data: { labels: l, datasets: stats.map((s,i)=>({label:s,data:l.map(k=>map[k][s]||0),backgroundColor:['#1cc88a','#f6c23e','#e74a3b','#4e73df','#858796','#36b9cc'][i%6]})) }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { tooltip: { mode: 'index', intersect: false } } } })); }
        function renderOwnershipChart(dist) { const c=document.getElementById('ownershipChart').getContext('2d'), l=Object.keys(dist).sort((a,b)=>parseInt(a)-parseInt(b)); if(ownChartInstance) ownChartInstance.destroy(); ownChartInstance = new Chart(c, { type: 'doughnut', data: { labels: l, datasets: [{ data: l.map(k=>dist[k]), backgroundColor: ['#4e73df','#1cc88a','#36b9cc'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
        function renderPivotTable(map, stats) { document.getElementById("pivotTable").innerHTML = `<thead class="table-light"><tr><th class="row-header">Location</th>${stats.map(s=>`<th>${s}</th>`).join('')}<th class="fw-bold-total">Total</th></tr></thead><tbody>${Object.keys(map).sort().map(l=>{let t=0; return `<tr><td class="row-header">${l}</td>${stats.map(s=>{const c=map[l][s]||0;t+=c;return `<td>${c||'-'}</td>`}).join('')}<td class="fw-bold-total">${t}</td></tr>`}).join('')}</tbody>`; }

        loadData();
        function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>

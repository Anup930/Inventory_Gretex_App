<!-- V 5.1.7 -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gretex ERP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        
        /* SIDEBAR */
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #222e3c; color: white; padding-top: 20px; z-index: 1000; }
        .sidebar-header { text-align: center; margin-bottom: 30px; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #34495e; padding-bottom: 20px; }
        .sidebar a { color: #aab8c5; padding: 12px 25px; display: flex; align-items: center; text-decoration: none; transition: 0.3s; font-size: 0.95rem; }
        .sidebar a i { width: 25px; text-align: center; margin-right: 10px; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid #4e73df; }

        /* CONTENT */
        .main-content { margin-left: 250px; padding: 30px; }
        
        /* KPI CARDS WITH HOVER EFFECT */
        .stat-card { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            transition: all 0.3s; 
            border-left: 5px solid #ccc; 
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .stat-card h2 { font-weight: bold; margin: 10px 0 0 0; color: #333; }
        .icon-box { float: right; opacity: 0.2; font-size: 2.5rem; margin-top: -10px; }

        /* CHART POPUP (Hidden by default) */
        #hoverChartCard {
            display: none;
            position: absolute;
            z-index: 9999;
            width: 280px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            pointer-events: none; /* Allows mouse to move smoothly without flickering */
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* CONTAINERS */
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        
        .table-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; margin-top: 0; }
        .pivot-table th { background-color: #e2e6ea; font-size: 0.85rem; text-transform: uppercase; border: 1px solid #dee2e6; }
        .pivot-table td { font-size: 0.9rem; border: 1px solid #dee2e6; }
        .fw-bold-total { font-weight: 700; background-color: #d1d3e2 !important; }
    </style>
    
    <script>
        const user = JSON.parse(sessionStorage.getItem("user"));
        if (!user) window.location.href = "index.html";
    </script>
</head>
<body>

    <div class="sidebar">
        <h4 class="text-center mb-4"><i class="fas fa-warehouse"></i> Gretex ERP</h4>
        <a href="dashboard.html" class="active"><i class="fas fa-home"></i> Dashboard</a>
        <a href="Emp.html"><i class="fas fa-user-plus"></i> Add Employee</a>
        <a href="asset.html"><i class="fas fa-laptop-medical"></i> Add Asset</a>
        <a href="allocate.html"><i class="fas fa-hand-holding"></i> Allocate Asset</a>
        <a href="Return.html"><i class="fas fa-undo"></i> Return Asset</a>
        <a href="AssetHistory.html"><i class="fas fa-history"></i> Asset History</a>
        <a href="EmpHistory.html"><i class="fas fa-user-clock"></i> Emp History</a>
        <a href="Repair.html"><i class="fas fa-tools"></i> Maintenance</a>
        <a href="stock.html"><i class="fas fa-exchange-alt"></i> Stock In/Out</a>
        <a href="data.html"><i class="fas fa-database"></i> Import / Export</a>
        <div style="margin-top: 40px; border-top: 1px solid #3e4b5b;"></div>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold text-dark m-0">Analytics Dashboard</h3>
                <small class="text-muted">Live Inventory Status</small>
            </div>
            <div class="bg-white px-3 py-2 rounded shadow-sm">
                <i class="fas fa-user-circle text-primary me-2"></i>
                <span class="fw-bold" id="userNameDisplay">User</span>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card" style="border-left-color: #4e73df;" onmouseenter="showBreakdown(this, 'total')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-primary"><i class="fas fa-laptop"></i></div>
                    <p class="text-primary">Total Assets</p>
                    <h2 id="totalAssets">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-left-color: #1cc88a;" onmouseenter="showBreakdown(this, 'available')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-success"><i class="fas fa-check-circle"></i></div>
                    <p class="text-success">Available</p>
                    <h2 id="totalAvailable">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-left-color: #f6c23e;" onmouseenter="showBreakdown(this, 'allocated')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-warning"><i class="fas fa-user-check"></i></div>
                    <p class="text-warning">Allocated</p>
                    <h2 id="totalAllocated">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-left-color: #e74a3b;" onmouseenter="showBreakdown(this, 'repair')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-danger"><i class="fas fa-tools"></i></div>
                    <p class="text-danger">Repair / Scrap</p>
                    <h2 id="totalRepair">0</h2>
                </div>
            </div>
        </div>

        <div id="hoverChartCard" class="card">
            <div class="card-body p-2">
                <h6 class="text-center small fw-bold text-muted mb-2 border-bottom pb-1" id="hoverChartTitle">Asset Breakdown</h6>
                <div style="height: 180px;">
                    <canvas id="hoverChartCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-8">
                <div class="chart-box">
                    <h6 class="text-muted mb-3 fw-bold">Location-wise Asset Status</h6>
                    <div class="chart-wrapper">
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-box">
                    <h6 class="text-muted mb-3 fw-bold">Assets per Employee</h6>
                    <div class="chart-wrapper">
                        <canvas id="ownershipChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="chart-box">
                    <h6 class="text-muted mb-3 fw-bold">Category Distribution</h6>
                    <div class="chart-wrapper">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-box">
                    <h6 class="text-muted mb-3 fw-bold">Brand Distribution</h6>
                    <div class="chart-wrapper">
                        <canvas id="brandChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <h5 class="text-dark mb-3 fw-bold"><i class="fas fa-table me-2"></i>Location vs Status Summary</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover pivot-table text-center align-middle" id="pivotTable">
                            <thead class="table-light"><tr><th>Loading Data...</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ********************************************
        // PASTE YOUR GAS WEB APP URL HERE
        const API_URL = "YOUR_DEPLOYED_GAS_URL_HERE"; 
        // ********************************************
        
        document.getElementById("userNameDisplay").innerText = user.name;

        // Global Instances
        let locChartInstance = null;
        let ownChartInstance = null;
        let catChartInstance = null;
        let brandChartInstance = null;
        
        // HOVER CHART INSTANCE
        let hoverChartInstance = null;
        
        // Data for Hover Charts
        let breakdownData = {
            total: {},
            available: {},
            allocated: {},
            repair: {}
        };

        // --- FETCH DATA ---
        async function loadData() {
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "exportData", sheetName: "Asset_Master" })
                });
                const result = await response.json();

                if (result.status === "success" && result.data.length > 0) {
                    processDashboard(result.data);
                }
            } catch (error) { console.error("Error:", error); }
        }

        function processDashboard(data) {
            const headers = data[0]; 
            const rows = data.slice(1);

            const getIdx = (name) => headers.findIndex(h => h.toString().toLowerCase().includes(name.toLowerCase()));
            const IDX_LOC = getIdx("Location");
            const IDX_USER = getIdx("Assigned"); 
            const IDX_STATUS = getIdx("Status");
            const IDX_CAT = getIdx("Category");
            const IDX_BRAND = getIdx("Brand");

            if(IDX_LOC === -1 || IDX_STATUS === -1) { alert("Column Error"); return; }

            // Counters
            let total = 0, available = 0, allocated = 0, repair = 0;
            
            // Maps for Main Charts
            const locationMap = {}, categoryMap = {}, brandMap = {}, userAssetCounts = {};
            const allStatuses = new Set();

            rows.forEach(r => {
                const loc = (r[IDX_LOC] || "Unknown").toString().trim();
                const status = (r[IDX_STATUS] || "Unknown").toString().trim();
                const user = (r[IDX_USER] || "Unassigned").toString().trim();
                const cat = (r[IDX_CAT] || "Unknown").toString().trim();
                const brand = (r[IDX_BRAND] || "Unknown").toString().trim();

                if(loc === "") return;

                // 1. KPI & HOVER DATA CALCULATION
                total++;
                if(!breakdownData.total[cat]) breakdownData.total[cat] = 0;
                breakdownData.total[cat]++;

                if(status === 'Available') {
                    available++;
                    if(!breakdownData.available[cat]) breakdownData.available[cat] = 0;
                    breakdownData.available[cat]++;
                } else if(status === 'In-Use') {
                    allocated++;
                    if(!breakdownData.allocated[cat]) breakdownData.allocated[cat] = 0;
                    breakdownData.allocated[cat]++;
                } else if(['Repair', 'Damaged', 'Scrap'].includes(status)) {
                    repair++;
                    if(!breakdownData.repair[cat]) breakdownData.repair[cat] = 0;
                    breakdownData.repair[cat]++;
                }

                // 2. MAIN CHARTS DATA
                allStatuses.add(status);

                if (!locationMap[loc]) locationMap[loc] = {};
                if (!locationMap[loc][status]) locationMap[loc][status] = 0;
                locationMap[loc][status]++;

                if (!categoryMap[cat]) categoryMap[cat] = {};
                if (!categoryMap[cat][status]) categoryMap[cat][status] = 0;
                categoryMap[cat][status]++;

                if (!brandMap[brand]) brandMap[brand] = {};
                if (!brandMap[brand][status]) brandMap[brand][status] = 0;
                brandMap[brand][status]++;

                if(status === 'In-Use' && user !== "Unassigned" && user !== "") {
                    userAssetCounts[user] = (userAssetCounts[user] || 0) + 1;
                }
            });

            // Update UI
            document.getElementById("totalAssets").innerText = total;
            document.getElementById("totalAvailable").innerText = available;
            document.getElementById("totalAllocated").innerText = allocated;
            document.getElementById("totalRepair").innerText = repair;

            const ownershipDist = {};
            Object.values(userAssetCounts).forEach(count => {
                const key = count + (count === 1 ? " Device" : " Devices");
                ownershipDist[key] = (ownershipDist[key] || 0) + 1;
            });

            // Render Main Charts
            const statusArray = Array.from(allStatuses).sort();
            renderPivotTable(locationMap, statusArray);
            renderStackedChart('locationChart', locationMap, statusArray, locChartInstance, (i) => locChartInstance = i);
            renderOwnershipChart(ownershipDist);
            renderStackedChart('categoryChart', categoryMap, statusArray, catChartInstance, (i) => catChartInstance = i);
            renderStackedChart('brandChart', brandMap, statusArray, brandChartInstance, (i) => brandChartInstance = i);
        }

        // --- HOVER CHART LOGIC ---
        function showBreakdown(element, type) {
            const popup = document.getElementById("hoverChartCard");
            const titleEl = document.getElementById("hoverChartTitle");
            
            // 1. Position Popup
            const rect = element.getBoundingClientRect();
            popup.style.display = "block";
            // Position slightly to the right and down from the card top
            popup.style.top = (rect.top + window.scrollY + 10) + "px";
            popup.style.left = (rect.left + rect.width - 20) + "px";

            // 2. Set Title
            const titles = {
                'total': 'Total Assets by Type',
                'available': 'Available Stock by Type',
                'allocated': 'Allocated Assets by Type',
                'repair': 'Repair/Scrap by Type'
            };
            titleEl.innerText = titles[type] || "Breakdown";

            // 3. Prepare Data
            const dataObj = breakdownData[type];
            const labels = Object.keys(dataObj);
            const data = Object.values(dataObj);

            // Handle Empty Data
            if(labels.length === 0) {
                labels.push("No Data");
                data.push(1);
            }

            // 4. Render Chart
            const ctx = document.getElementById("hoverChartCanvas").getContext("2d");
            if(hoverChartInstance) hoverChartInstance.destroy();

            hoverChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 }, // Disable animation for instant hover effect
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } }
                    }
                }
            });
        }

        function hideBreakdown() {
            const popup = document.getElementById("hoverChartCard");
            popup.style.display = "none";
        }

        // --- CHART RENDERERS (Main Dashboard) ---
        function renderStackedChart(canvasId, dataMap, statuses, instance, setInstance) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = Object.keys(dataMap).sort();
            if(instance) instance.destroy();
            const datasets = statuses.map((status, index) => {
                const colors = ['#1cc88a', '#f6c23e', '#e74a3b', '#4e73df', '#858796', '#36b9cc'];
                return {
                    label: status,
                    data: labels.map(label => dataMap[label][status] || 0),
                    backgroundColor: colors[index % colors.length]
                };
            });
            const newChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                    plugins: { legend: { position: 'top' } }
                }
            });
            setInstance(newChart);
        }

        function renderOwnershipChart(distMap) {
            const ctx = document.getElementById('ownershipChart').getContext('2d');
            if(ownChartInstance) ownChartInstance.destroy();
            const labels = Object.keys(distMap).sort((a,b) => parseInt(a) - parseInt(b));
            ownChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: labels.map(k => distMap[k]), backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderPivotTable(locMap, statuses) {
            const table = document.getElementById("pivotTable");
            const locations = Object.keys(locMap).sort();
            let html = `<thead class="table-light"><tr><th class="row-header">Location</th>` + 
                       statuses.map(s => `<th>${s}</th>`).join('') + `<th class="fw-bold-total">Total</th></tr></thead><tbody>`;
            
            locations.forEach(loc => {
                let rowTotal = 0;
                html += `<tr><td class="row-header">${loc}</td>`;
                statuses.forEach(s => {
                    const count = locMap[loc][s] || 0;
                    rowTotal += count;
                    html += `<td>${count || '-'}</td>`;
                });
                html += `<td class="fw-bold-total">${rowTotal}</td></tr>`;
            });
            table.innerHTML = html + "</tbody>";
        }

        loadData();
        function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>

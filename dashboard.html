<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gretex ERP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        
        /* SIDEBAR */
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #222e3c; color: white; padding-top: 20px; z-index: 1000; }
        .sidebar-header { text-align: center; margin-bottom: 30px; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #34495e; padding-bottom: 20px; }
        .sidebar a { color: #aab8c5; padding: 12px 25px; display: flex; align-items: center; text-decoration: none; transition: 0.3s; font-size: 0.95rem; }
        .sidebar a i { width: 25px; text-align: center; margin-right: 10px; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid #4e73df; }

        /* CONTENT */
        .main-content { margin-left: 250px; padding: 30px; }
        
        /* CARDS & CONTAINERS */
        .stat-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; border-left: 5px solid #ccc; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h2 { font-weight: bold; margin: 10px 0 0 0; color: #333; }
        .icon-box { float: right; opacity: 0.2; font-size: 2.5rem; margin-top: -10px; }

        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: 100%; min-height: 350px; }
        
        /* PIVOT TABLE STYLES */
        .table-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; }
        .pivot-table th { background-color: #f8f9fa; font-size: 0.85rem; text-transform: uppercase; }
        .pivot-table td { font-size: 0.9rem; }
        .fw-bold-total { font-weight: 700; background-color: #eef2ff !important; }
    </style>
    
    <script>
        const user = JSON.parse(sessionStorage.getItem("user"));
        if (!user) window.location.href = "index.html";
    </script>
</head>
<body>

    <div class="sidebar">
        <h4 class="text-center mb-4"><i class="fas fa-warehouse"></i> Gretex ERP</h4>
        <a href="dashboard.html" class="active"><i class="fas fa-home"></i> Dashboard</a>
        <a href="Emp.html"><i class="fas fa-user-plus"></i> Add Employee</a>
        <a href="asset.html"><i class="fas fa-laptop-medical"></i> Add Asset</a>
        <a href="allocate.html"><i class="fas fa-hand-holding"></i> Allocate Asset</a>
        <a href="Return.html"><i class="fas fa-undo"></i> Return Asset</a>
        <a href="AssetHistory.html"><i class="fas fa-history"></i> Asset History</a>
        <a href="EmpHistory.html"><i class="fas fa-user-clock"></i> Emp History</a>
        <a href="Repair.html"><i class="fas fa-tools"></i> Maintenance</a>
        <a href="stock.html"><i class="fas fa-exchange-alt"></i> Stock In/Out</a>
        <a href="data.html"><i class="fas fa-database"></i> Import / Export</a>
        <div style="margin-top: 40px; border-top: 1px solid #3e4b5b;"></div>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold text-dark m-0">Analytics Dashboard</h3>
                <small class="text-muted">Real-time Inventory Intelligence</small>
            </div>
            <div class="bg-white px-3 py-2 rounded shadow-sm">
                <i class="fas fa-user-circle text-primary me-2"></i>
                <span class="fw-bold" id="userNameDisplay">User</span>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card" style="border-left-color: #4e73df;">
                    <div class="icon-box text-primary"><i class="fas fa-laptop"></i></div>
                    <p class="text-primary">Total Assets</p>
                    <h2 id="totalAssets">...</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-left-color: #1cc88a;">
                    <div class="icon-box text-success"><i class="fas fa-check-circle"></i></div>
                    <p class="text-success">Available</p>
                    <h2 id="totalAvailable">...</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-left-color: #f6c23e;">
                    <div class="icon-box text-warning"><i class="fas fa-user-check"></i></div>
                    <p class="text-warning">Allocated</p>
                    <h2 id="totalAllocated">...</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-left-color: #e74a3b;">
                    <div class="icon-box text-danger"><i class="fas fa-tools"></i></div>
                    <p class="text-danger">Repair / Scrap</p>
                    <h2 id="totalRepair">...</h2>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-8">
                <div class="chart-box">
                    <h6 class="text-muted mb-3 fw-bold">Location-wise Asset Status</h6>
                    <canvas id="locationChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-box">
                    <h6 class="text-muted mb-3 fw-bold">Asset Ownership (Count per User)</h6>
                    <canvas id="ownershipChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <h6 class="text-muted mb-3 fw-bold">Detailed Location vs Status Matrix</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover pivot-table text-center align-middle" id="pivotTable">
                            <thead class="table-light">
                                <tr><th>Loading Data...</th></tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ********************************************
        // PASTE YOUR GAS WEB APP URL HERE
        const API_URL = "YOUR_DEPLOYED_GAS_URL_HERE"; 
        // ********************************************
        
        document.getElementById("userNameDisplay").innerText = user.name;

        // --- FETCH & PROCESS DATA ---
        async function loadData() {
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "exportData", sheetName: "Asset_Master" })
                });
                const result = await response.json();

                if (result.status === "success" && result.data.length > 1) {
                    const rows = result.data.slice(1); // Remove Header
                    processDashboard(rows);
                } else {
                    alert("No Data Found");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        function processDashboard(rows) {
            // Data Indices based on your Sheet:
            // 10: Location, 11: AssignedTo, 12: Status
            const IDX_LOC = 10;
            const IDX_USER = 11;
            const IDX_STATUS = 12;

            // 1. KPI COUNTERS
            const total = rows.length;
            const available = rows.filter(r => r[IDX_STATUS] === 'Available').length;
            const allocated = rows.filter(r => r[IDX_STATUS] === 'In-Use').length;
            const repair = rows.filter(r => ['Repair', 'Damaged', 'Scrap'].includes(r[IDX_STATUS])).length;

            document.getElementById("totalAssets").innerText = total;
            document.getElementById("totalAvailable").innerText = available;
            document.getElementById("totalAllocated").innerText = allocated;
            document.getElementById("totalRepair").innerText = repair;

            // 2. LOCATION vs STATUS DATA (Pivot)
            const locationMap = {}; // { 'Mumbai': { 'Available': 5, 'In-Use': 2 } }
            const allStatuses = new Set();

            rows.forEach(r => {
                const loc = r[IDX_LOC] || "Unknown";
                const status = r[IDX_STATUS] || "Unknown";
                
                if (!locationMap[loc]) locationMap[loc] = {};
                if (!locationMap[loc][status]) locationMap[loc][status] = 0;
                
                locationMap[loc][status]++;
                allStatuses.add(status);
            });

            // 3. OWNERSHIP DATA (How many users have 1, 2, 3 assets)
            const userAssetCounts = {};
            rows.forEach(r => {
                if(r[IDX_STATUS] === 'In-Use' && r[IDX_USER] && r[IDX_USER] !== "Unassigned") {
                    userAssetCounts[r[IDX_USER]] = (userAssetCounts[r[IDX_USER]] || 0) + 1;
                }
            });

            const ownershipDist = {}; // { '1 Asset': 10 users, '2 Assets': 5 users }
            Object.values(userAssetCounts).forEach(count => {
                const key = count + (count === 1 ? " Asset" : " Assets");
                ownershipDist[key] = (ownershipDist[key] || 0) + 1;
            });

            // --- RENDER UI ---
            renderPivotTable(locationMap, Array.from(allStatuses));
            renderLocationChart(locationMap, Array.from(allStatuses));
            renderOwnershipChart(ownershipDist);
        }

        // --- RENDER PIVOT TABLE ---
        function renderPivotTable(locMap, statuses) {
            const table = document.getElementById("pivotTable");
            const locations = Object.keys(locMap).sort();
            statuses.sort(); // Sort statuses alphabetically

            // Header Row
            let thead = `<thead class="table-light"><tr><th class="text-start">Location</th>`;
            statuses.forEach(s => thead += `<th>${s}</th>`);
            thead += `<th class="fw-bold-total">Grand Total</th></tr></thead>`;

            // Body Rows
            let tbody = `<tbody>`;
            locations.forEach(loc => {
                let rowHtml = `<tr><td class="text-start fw-bold">${loc}</td>`;
                let rowTotal = 0;
                
                statuses.forEach(s => {
                    const count = locMap[loc][s] || 0;
                    rowHtml += `<td>${count > 0 ? count : '-'}</td>`;
                    rowTotal += count;
                });
                
                rowHtml += `<td class="fw-bold-total">${rowTotal}</td></tr>`;
                tbody += rowHtml;
            });
            tbody += `</tbody>`;

            table.innerHTML = thead + tbody;
        }

        // --- RENDER LOCATION CHART (Stacked Bar) ---
        function renderLocationChart(locMap, statuses) {
            const ctx = document.getElementById('locationChart').getContext('2d');
            const locations = Object.keys(locMap).sort();
            
            // Prepare Datasets for Stacking
            const datasets = statuses.map((status, index) => {
                const data = locations.map(loc => locMap[loc][status] || 0);
                // Generate distinct colors
                const colors = ['#1cc88a', '#f6c23e', '#e74a3b', '#4e73df', '#858796', '#36b9cc']; 
                return {
                    label: status,
                    data: data,
                    backgroundColor: colors[index % colors.length]
                };
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: locations,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        // --- RENDER OWNERSHIP CHART (Pie/Doughnut) ---
        function renderOwnershipChart(distMap) {
            const ctx = document.getElementById('ownershipChart').getContext('2d');
            
            // Sort keys numerically (1 Asset, 2 Assets...)
            const labels = Object.keys(distMap).sort((a,b) => parseInt(a) - parseInt(b));
            const data = labels.map(k => distMap[k]);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Init
        loadData();

        function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>

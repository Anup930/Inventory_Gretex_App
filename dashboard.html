<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gretex ERP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #222e3c; color: white; padding-top: 20px; z-index: 1000; }
        .sidebar-header { text-align: center; margin-bottom: 30px; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #34495e; padding-bottom: 20px; }
        .sidebar a { color: #aab8c5; padding: 12px 25px; display: flex; align-items: center; text-decoration: none; transition: 0.3s; font-size: 0.95rem; }
        .sidebar a i { width: 25px; text-align: center; margin-right: 10px; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid #4e73df; }
        .main-content { margin-left: 250px; padding: 30px; }
        
        /* CARDS */
        .stat-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.3s; border-left: 5px solid #ccc; cursor: pointer; position: relative; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .stat-card h2 { font-weight: bold; margin: 10px 0 0 0; color: #333; }
        
        .alert-card { border-left: 5px solid #e74a3b !important; background: #fff5f5; }
        .warning-card { border-left: 5px solid #f6c23e !important; background: #fffdf5; }
        .violation-card { border-left: 5px solid #6610f2 !important; background: #f3f0ff; }

        #hoverChartCard { display: none; position: absolute; z-index: 9999; width: 280px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); pointer-events: none; border: 1px solid rgba(0,0,0,0.1); }
        
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .table-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; margin-top: 0; }
        .pivot-table th { background-color: #e2e6ea; font-size: 0.85rem; text-transform: uppercase; border: 1px solid #dee2e6; }
        .pivot-table td { font-size: 0.9rem; border: 1px solid #dee2e6; }
        .fw-bold-total { font-weight: 700; background-color: #d1d3e2 !important; }
    </style>
    <script>
        const user = JSON.parse(sessionStorage.getItem("user"));
        if (!user) window.location.href = "index.html";
    </script>
</head>
<body>

    <div class="sidebar">
        <h4 class="text-center mb-4"><i class="fas fa-warehouse"></i> Gretex ERP</h4>
        <a href="dashboard.html" class="active"><i class="fas fa-home"></i> Dashboard</a>
        <a href="Emp.html"><i class="fas fa-user-plus"></i> Add Employee</a>
        <a href="asset.html"><i class="fas fa-laptop-medical"></i> Add Asset</a>
        <a href="allocate.html"><i class="fas fa-hand-holding"></i> Allocate Asset</a>
        <a href="Return.html"><i class="fas fa-undo"></i> Return Asset</a>
        <a href="AssetHistory.html"><i class="fas fa-history"></i> Asset History</a>
        <a href="EmpHistory.html"><i class="fas fa-user-clock"></i> Emp History</a>
        <a href="Repair.html"><i class="fas fa-tools"></i> Maintenance</a>
        <a href="stock.html"><i class="fas fa-exchange-alt"></i> Stock In/Out</a>
        <a href="Shift.html"><i class="fas fa-exchange-alt"></i> shift Laptop</a>
        <a href="data.html"><i class="fas fa-database"></i> Import / Export</a>
        <div style="margin-top: 40px; border-top: 1px solid #3e4b5b;"></div>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h3 class="fw-bold text-dark m-0">Analytics Dashboard</h3><small class="text-muted">Live Inventory Status</small></div>
            <div class="bg-white px-3 py-2 rounded shadow-sm"><i class="fas fa-user-circle text-primary me-2"></i><span class="fw-bold" id="userNameDisplay">User</span></div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col">
                <div class="stat-card" style="border-left-color: #4e73df;" onmouseenter="showBreakdown(this, 'total')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-primary"><i class="fas fa-laptop"></i></div><p class="text-primary">Total Assets</p><h2 id="totalAssets">0</h2>
                </div>
            </div>
            <div class="col">
                <div class="stat-card" style="border-left-color: #1cc88a;" onclick="showAvailableModal()" onmouseenter="showBreakdown(this, 'available')" onmouseleave="hideBreakdown()" title="Click to view Stock List">
                    <div class="icon-box text-success"><i class="fas fa-check-circle"></i></div><p class="text-success">Available</p><h2 id="totalAvailable">0</h2>
                </div>
            </div>
            <div class="col">
                <div class="stat-card" style="border-left-color: #f6c23e;" onmouseenter="showBreakdown(this, 'allocated')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-warning"><i class="fas fa-user-check"></i></div><p class="text-warning">Allocated</p><h2 id="totalAllocated">0</h2>
                </div>
            </div>
            <div class="col">
                <div class="stat-card" style="border-left-color: #858796;" onmouseenter="showBreakdown(this, 'repair')" onmouseleave="hideBreakdown()">
                    <div class="icon-box text-secondary"><i class="fas fa-tools"></i></div><p class="text-secondary">Maintenance</p><h2 id="totalRepair">0</h2>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="stat-card alert-card" onclick="showInactiveModal()" title="View Details">
                    <div class="icon-box text-danger"><i class="fas fa-exclamation-triangle"></i></div><p class="text-danger fw-bold small text-uppercase">Inactive Emp With Asset</p><h2 id="totalInactiveAssets">0</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card warning-card" onclick="showPendingAllocationModal()" title="View Details">
                    <div class="icon-box text-warning"><i class="fas fa-user-clock"></i></div><p class="text-warning fw-bold text-dark small text-uppercase">Pending Allocation (Req=Yes)</p><h2 id="totalPendingAlloc">0</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card violation-card" onclick="showUnnecessaryModal()" title="View Details">
                    <div class="icon-box" style="color: #6610f2;"><i class="fas fa-user-tag"></i></div><p style="color: #6610f2;" class="fw-bold small text-uppercase">Unexpected (Req=No but Has)</p><h2 id="totalUnnecessaryAlloc">0</h2>
                </div>
            </div>
        </div>

        <div id="hoverChartCard" class="card">
            <div class="card-body p-2">
                <h6 class="text-center small fw-bold text-muted mb-2 border-bottom pb-1" id="hoverChartTitle">Breakdown</h6>
                <div style="height: 180px;"><canvas id="hoverChartCanvas"></canvas></div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-8"><div class="chart-box"><h6 class="text-muted mb-3 fw-bold">Location-wise Asset Status</h6><div class="chart-wrapper"><canvas id="locationChart"></canvas></div></div></div>
            <div class="col-md-4"><div class="chart-box"><h6 class="text-muted mb-3 fw-bold">Assets per Employee</h6><div class="chart-wrapper"><canvas id="ownershipChart"></canvas></div></div></div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6"><div class="chart-box"><h6 class="text-muted mb-3 fw-bold">Category Distribution</h6><div class="chart-wrapper"><canvas id="categoryChart"></canvas></div></div></div>
            <div class="col-md-6"><div class="chart-box"><h6 class="text-muted mb-3 fw-bold">Brand Distribution</h6><div class="chart-wrapper"><canvas id="brandChart"></canvas></div></div></div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="chart-box">
                    <h6 class="text-muted mb-3 fw-bold">Overall Asset Status Distribution <span class="badge bg-info text-dark ms-2">Click Bars to View Data</span></h6>
                    <div class="chart-wrapper" style="height: 250px;"><canvas id="statusChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <h5 class="text-dark mb-3 fw-bold"><i class="fas fa-table me-2"></i>Location vs Status Summary</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover pivot-table text-center align-middle" id="pivotTable">
                            <thead class="table-light"><tr><th>Loading...</th></tr></thead><tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pendingAllocModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title">Pending Allocation (Asset Req = Yes)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="text-muted small">Active Employees who need assets but hold 0.</p><div class="d-flex justify-content-end mb-2"><button onclick="downloadReport('pending')" class="btn btn-sm btn-dark">Download CSV</button></div><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Emp ID</th><th>Name</th><th>Email</th><th>Location</th></tr></thead><tbody id="pendingAllocBody"></tbody></table></div></div></div></div></div>
    
    <div class="modal fade" id="unnecessaryModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-white text-primary" style="border-bottom: 3px solid #6610f2;"><h5 class="modal-title" style="color: #6610f2;">Unexpected Allocation (Asset Req = No)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="text-muted small">Employees marked "Asset Req: No" but holding assets.</p><div class="d-flex justify-content-end mb-2"><button onclick="downloadReport('unnecessary')" class="btn btn-sm btn-dark">Download CSV</button></div><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Emp ID</th><th>Name</th><th>Asset Count</th><th>Asset Req Status</th></tr></thead><tbody id="unnecessaryBody"></tbody></table></div></div></div></div></div>

    <div class="modal fade" id="inactiveModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">Assets with Inactive Employees</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="d-flex justify-content-end mb-2"><button onclick="downloadReport('inactive')" class="btn btn-sm btn-success">Download CSV</button></div><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Asset ID</th><th>Serial No</th><th>Type</th><th>Assigned To</th><th>Emp ID</th></tr></thead><tbody id="inactiveTableBody"></tbody></table></div></div></div></div></div>

    <div class="modal fade" id="commonDetailModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="commonModalTitle">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row g-2 mb-3"><div class="col-md-8"><input type="text" id="commonSearch" class="form-control" placeholder="Search..." onkeyup="filterCommonTable()"></div><div class="col-md-4 text-end"><button onclick="downloadCommonReport()" class="btn btn-dark w-100">Download</button></div></div><div class="table-responsive" style="max-height: 500px; overflow-y: auto;"><table class="table table-bordered table-hover text-center align-middle"><thead class="table-light sticky-top" id="commonTableHead"></thead><tbody id="commonTableBody"></tbody></table></div></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbypAYvqG8Lw5-tVd-JaE4PNc6FEzkTRsEBr36uqGwA92wTxxMAOAgV9xeW9QPm4Q-0V2w/exec"; 
        document.getElementById("userNameDisplay").innerText = user.name;

        let locChartInstance = null, ownChartInstance = null, catChartInstance = null, brandChartInstance = null, hoverChartInstance = null, statusChartInstance = null;
        let breakdownData = { total: {}, available: {}, allocated: {}, repair: {} };
        
        let inactiveAssetsList = [], availableAssetsList = [], pendingAllocationList = [], unnecessaryAllocList = [], allAssetRows = [], currentDetailList = [];

        async function loadData() {
            try {
                const assetReq = fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "exportData", sheetName: "Asset_Master" }) });
                const empReq = fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "exportData", sheetName: "Employees" }) });
                const [assetRes, empRes] = await Promise.all([assetReq, empReq].map(p => p.then(r => r.json())));

                if (assetRes.status === "success" && empRes.status === "success") {
                    processDashboard(assetRes.data, empRes.data);
                }
            } catch (error) { console.error("Error:", error); }
        }

        function processDashboard(assetData, empData) {
            // 1. Process Employees
            const empHeaders = empData[0];
            const empRows = empData.slice(1);
            const getEmpIdx = (name) => empHeaders.findIndex(h => h.toString().toLowerCase().includes(name.toLowerCase()));
            
            const EMP_ID = getEmpIdx("ID"); 
            const EMP_NAME = getEmpIdx("Name");
            const EMP_EMAIL = getEmpIdx("Email");
            const EMP_LOC = getEmpIdx("Location");
            const EMP_STATUS = getEmpIdx("Status");
            const EMP_REQ = getEmpIdx("Asset Requi"); 

            const inactiveEmpMap = {};
            const empAssetCountMap = {}; 
            const activeEmpReqList = [];
            const noAssetReqList = [];

            empRows.forEach(row => {
                const id = row[EMP_ID];
                const name = row[EMP_NAME];
                const status = (row[EMP_STATUS] || "").toString().trim();
                const req = (row[EMP_REQ] || "").toString().trim();

                empAssetCountMap[name.toLowerCase()] = 0; 

                if(status === 'Inactive') {
                    inactiveEmpMap[name.toLowerCase()] = id || "N/A";
                } else if(status === 'Active') {
                    if(req === 'Yes') activeEmpReqList.push({ id: id, name: name, email: row[EMP_EMAIL], loc: row[EMP_LOC] });
                    else noAssetReqList.push({ id: id, name: name, req: req });
                }
            });

            // --- KEY FIX: SORT KEYS BY LENGTH DESCENDING ---
            // This prevents "Prashant" matching before "Prashant Nath"
            const sortedEmpNames = Object.keys(empAssetCountMap).sort((a, b) => b.length - a.length);

            // 2. Process Assets
            const headers = assetData[0]; 
            const rows = assetData.slice(1);
            const getIdx = (head, name) => head.findIndex(h => h.toString().toLowerCase().includes(name.toLowerCase()));

            const IDX_ID = getIdx(headers, "AssetID");
            const IDX_LOC = getIdx(headers, "Location");
            const IDX_CAT = getIdx(headers, "Category");
            const IDX_BRAND = getIdx(headers, "Brand");
            const IDX_SERIAL = getIdx(headers, "Serial");
            const IDX_STATUS = getIdx(headers, "Status"); 
            const IDX_USER = getIdx(headers, "Assigned");

            allAssetRows = rows.map(r => ({
                id: r[IDX_ID], serial: r[IDX_SERIAL], loc: r[IDX_LOC], user: r[IDX_USER],
                status: r[IDX_STATUS], cat: r[IDX_CAT], brand: r[IDX_BRAND]
            }));

            let total = 0, available = 0, allocated = 0, repair = 0;
            const locationMap = {}, categoryMap = {}, brandMap = {}, userAssetCounts = {}, statusMap = {};
            const allStatuses = new Set();
            
            inactiveAssetsList = [];
            availableAssetsList = [];

            rows.forEach(r => {
                const loc = (r[IDX_LOC] || "Unknown").toString().trim();
                const status = (r[IDX_STATUS] || "Unknown").toString().trim();
                const user = (r[IDX_USER] || "Unassigned").toString().trim();
                const cat = (r[IDX_CAT] || "Unknown").toString().trim();
                const brand = (r[IDX_BRAND] || "Unknown").toString().trim();
                const assetId = r[IDX_ID];
                const serial = r[IDX_SERIAL];

                if(loc === "") return;

                total++;
                breakdownData.total[cat] = (breakdownData.total[cat] || 0) + 1;
                statusMap[status] = (statusMap[status] || 0) + 1;

                if(status === 'Available') {
                    available++;
                    breakdownData.available[cat] = (breakdownData.available[cat] || 0) + 1;
                    availableAssetsList.push({ id: assetId, serial: serial, cat: cat, brand: brand, loc: loc });
                } else if(status === 'In-Use') {
                    allocated++;
                    breakdownData.allocated[cat] = (breakdownData.allocated[cat] || 0) + 1;
                    
                    const userLower = user.toLowerCase();
                    
                    // --- IMPROVED NAME MATCHING LOGIC ---
                    for(const empName of sortedEmpNames) {
                        if(userLower.includes(empName)) {
                            empAssetCountMap[empName]++;
                            break; // Stop after finding longest match
                        }
                    }

                    for (const [inactiveName, empId] of Object.entries(inactiveEmpMap)) {
                        if (userLower.includes(inactiveName)) {
                            inactiveAssetsList.push({ assetId: assetId, serial: serial, type: cat, user: user, empId: empId });
                            break;
                        }
                    }
                } else if(['Repair', 'Damaged', 'Scrap'].includes(status)) {
                    repair++;
                    breakdownData.repair[cat] = (breakdownData.repair[cat] || 0) + 1;
                }

                allStatuses.add(status);
                if (!locationMap[loc]) locationMap[loc] = {}; locationMap[loc][status] = (locationMap[loc][status] || 0) + 1;
                if (!categoryMap[cat]) categoryMap[cat] = {}; categoryMap[cat][status] = (categoryMap[cat][status] || 0) + 1;
                if (!brandMap[brand]) brandMap[brand] = {}; brandMap[brand][status] = (brandMap[brand][status] || 0) + 1;
                if(status === 'In-Use' && user !== "Unassigned") userAssetCounts[user] = (userAssetCounts[user] || 0) + 1;
            });

            // 3. Audits
            pendingAllocationList = [];
            activeEmpReqList.forEach(emp => { if((empAssetCountMap[emp.name.toLowerCase()] || 0) === 0) pendingAllocationList.push(emp); });

            unnecessaryAllocList = [];
            noAssetReqList.forEach(emp => { const c = empAssetCountMap[emp.name.toLowerCase()] || 0; if(c > 0) unnecessaryAllocList.push({ id: emp.id, name: emp.name, count: c, req: emp.req }); });

            // Update UI
            document.getElementById("totalAssets").innerText = total;
            document.getElementById("totalAvailable").innerText = available;
            document.getElementById("totalAllocated").innerText = allocated;
            document.getElementById("totalRepair").innerText = repair;
            document.getElementById("totalInactiveAssets").innerText = inactiveAssetsList.length;
            document.getElementById("totalPendingAlloc").innerText = pendingAllocationList.length;
            document.getElementById("totalUnnecessaryAlloc").innerText = unnecessaryAllocList.length;

            renderPivotTable(locationMap, Array.from(allStatuses).sort());
            renderStackedChart('locationChart', locationMap, Array.from(allStatuses).sort(), locChartInstance, (i) => locChartInstance = i);
            renderOwnershipChart(Object.values(userAssetCounts).reduce((acc, c) => { acc[c+(c===1?" Device":" Devices")] = (acc[c+(c===1?" Device":" Devices")]||0)+1; return acc; }, {}));
            renderStackedChart('categoryChart', categoryMap, Array.from(allStatuses).sort(), catChartInstance, (i) => catChartInstance = i);
            renderStackedChart('brandChart', brandMap, Array.from(allStatuses).sort(), brandChartInstance, (i) => brandChartInstance = i);
            renderStatusChart(statusMap);
        }

        // --- COMMON MODAL LOGIC ---
        let commonRowBuilder = null;
        function openCommonModal(title, data, headers, rowFunc) {
            document.getElementById("commonModalTitle").innerText = title;
            document.getElementById("commonTableHead").innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`;
            currentDetailList = data;
            commonRowBuilder = rowFunc;
            renderCommonTable(data);
            new bootstrap.Modal(document.getElementById('commonDetailModal')).show();
        }
        function renderCommonTable(data) { document.getElementById("commonTableBody").innerHTML = data.map(commonRowBuilder).join('') || "<tr><td colspan='5'>No Data</td></tr>"; }
        function filterCommonTable() { const input = document.getElementById("commonSearch").value.toLowerCase(); renderCommonTable(currentDetailList.filter(item => Object.values(item).some(val => val.toString().toLowerCase().includes(input)))); }
        function downloadCommonReport() { if(currentDetailList.length) { const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([Papa.unparse(currentDetailList)], { type: 'text/csv' })); link.download = "List_Report.csv"; link.click(); } }

        function showAvailableModal() { openCommonModal("Available Stock", availableAssetsList, ['Asset ID','Serial','Category','Brand','Location'], i => `<tr><td class="fw-bold text-primary">${i.id}</td><td>${i.serial}</td><td>${i.cat}</td><td>${i.brand}</td><td>${i.loc}</td></tr>`); }
        function openStatusModal(status) {
            const list = allAssetRows.filter(r => r.status === status);
            if(status === 'In-Use') openCommonModal(`Details: ${status}`, list, ['Asset ID','Serial','Location','Assigned To','Category'], i => `<tr><td class="fw-bold">${i.id}</td><td>${i.serial}</td><td>${i.loc}</td><td class="text-primary fw-bold">${i.user}</td><td>${i.cat}</td></tr>`);
            else openCommonModal(`Details: ${status}`, list, ['Asset ID','Serial','Location','Category','Brand'], i => `<tr><td class="fw-bold">${i.id}</td><td>${i.serial}</td><td>${i.loc}</td><td>${i.cat}</td><td>${i.brand}</td></tr>`);
        }

        function showPendingAllocationModal() { const b = document.getElementById("pendingAllocBody"); b.innerHTML = pendingAllocationList.length ? pendingAllocationList.map(e => `<tr><td class="fw-bold">${e.id}</td><td>${e.name}</td><td>${e.email}</td><td>${e.loc}</td></tr>`).join('') : "<tr><td colspan='4'>No Pending</td></tr>"; new bootstrap.Modal(document.getElementById('pendingAllocModal')).show(); }
        function showUnnecessaryModal() { const b = document.getElementById("unnecessaryBody"); b.innerHTML = unnecessaryAllocList.length ? unnecessaryAllocList.map(e => `<tr><td class="fw-bold">${e.id}</td><td>${e.name}</td><td class="text-danger fw-bold">${e.count} Assets</td><td>${e.req}</td></tr>`).join('') : "<tr><td colspan='4'>No Unexpected Allocations</td></tr>"; new bootstrap.Modal(document.getElementById('unnecessaryModal')).show(); }
        function showInactiveModal() { const b = document.getElementById("inactiveTableBody"); b.innerHTML = inactiveAssetsList.length ? inactiveAssetsList.map(i => `<tr><td class="fw-bold text-danger">${i.assetId}</td><td>${i.serial}</td><td>${i.type}</td><td>${i.user}</td><td>${i.empId}</td></tr>`).join('') : "<tr><td colspan='5'>All Clear</td></tr>"; new bootstrap.Modal(document.getElementById('inactiveModal')).show(); }
        function downloadReport(type) { 
            let d = []; if(type==='pending') d=pendingAllocationList; else if(type==='unnecessary') d=unnecessaryAllocList; else if(type==='inactive') d=inactiveAssetsList;
            if(d.length) { const l = document.createElement("a"); l.href = URL.createObjectURL(new Blob([Papa.unparse(d)], { type: 'text/csv' })); l.download = `${type}_report.csv`; l.click(); }
        }

        function renderStatusChart(map) { const ctx=document.getElementById("statusChart").getContext("2d"); if(statusChartInstance) statusChartInstance.destroy(); statusChartInstance = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(map), datasets: [{ label: 'Count', data: Object.values(map), backgroundColor: ['#1cc88a','#f6c23e','#e74a3b','#4e73df','#858796','#36b9cc'], borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, onClick: (e, el) => { if(el.length) openStatusModal(Object.keys(map)[el[0].index]); } } }); }
        function showBreakdown(el, type) { const p=document.getElementById("hoverChartCard"); const r=el.getBoundingClientRect(); p.style.display="block"; p.style.top=(r.top+window.scrollY+10)+"px"; p.style.left=(r.left+r.width-20)+"px"; document.getElementById("hoverChartTitle").innerText=type.toUpperCase()+" Breakdown"; const d=breakdownData[type], l=Object.keys(d), v=Object.values(d); if(!l.length){l.push("No Data");v.push(1);} const c=document.getElementById("hoverChartCanvas").getContext("2d"); if(hoverChartInstance)hoverChartInstance.destroy(); hoverChartInstance=new Chart(c,{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:['#4e73df','#1cc88a','#36b9cc','#f6c23e']}]},options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},plugins:{legend:{position:'right',labels:{boxWidth:10,font:{size:10}}}}}}); }
        function hideBreakdown() { document.getElementById("hoverChartCard").style.display="none"; }
        function renderStackedChart(id, map, stats, inst, setInst) { const c=document.getElementById(id).getContext('2d'), l=Object.keys(map).sort(); if(inst) inst.destroy(); setInst(new Chart(c, { type: 'bar', data: { labels: l, datasets: stats.map((s,i)=>({label:s,data:l.map(k=>map[k][s]||0),backgroundColor:['#1cc88a','#f6c23e','#e74a3b','#4e73df','#858796','#36b9cc'][i%6]})) }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { tooltip: { mode: 'index', intersect: false } } } })); }
        function renderOwnershipChart(dist) { const c=document.getElementById('ownershipChart').getContext('2d'), l=Object.keys(dist).sort((a,b)=>parseInt(a)-parseInt(b)); if(ownChartInstance) ownChartInstance.destroy(); ownChartInstance = new Chart(c, { type: 'doughnut', data: { labels: l, datasets: [{ data: l.map(k=>dist[k]), backgroundColor: ['#4e73df','#1cc88a','#36b9cc'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
        function renderPivotTable(map, stats) { document.getElementById("pivotTable").innerHTML = `<thead class="table-light"><tr><th class="row-header">Location</th>${stats.map(s=>`<th>${s}</th>`).join('')}<th class="fw-bold-total">Total</th></tr></thead><tbody>${Object.keys(map).sort().map(l=>{let t=0; return `<tr><td class="row-header">${l}</td>${stats.map(s=>{const c=map[l][s]||0;t+=c;return `<td>${c||'-'}</td>`}).join('')}<td class="fw-bold-total">${t}</td></tr>`}).join('')}</tbody>`; }

        loadData();
        function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transaction History - Gretex ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #222e3c; color: white; padding-top: 20px; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar a { color: #aab8c5; padding: 12px 25px; display: flex; align-items: center; text-decoration: none; transition: 0.3s; font-size: 0.95rem; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid #4e73df; }
        .sidebar-menu { flex-grow: 1; overflow-y: auto; }
        .sidebar-footer { padding: 20px; border-top: 1px solid #3e4b5b; background-color: #1a2530; }

        .main-content { margin-left: 250px; padding: 30px; }
        .card-custom { background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: none; margin-bottom: 20px; }
        
        /* TABLE STYLING */
        .table-container { max-height: 500px; overflow-y: auto; position: relative; border-radius: 8px; border: 1px solid #ddd; }
        .table thead th { position: sticky; top: 0; background-color: #2c3e50; color: white; z-index: 1; text-align: center; }
        .table tbody td { vertical-align: middle; font-size: 0.9rem; text-align: center; }
        
        .badge-in { background-color: #d1e7dd; color: #0f5132; padding: 5px 10px; border-radius: 15px; font-weight: bold; border: 1px solid #badbcc; }
        .badge-out { background-color: #f8d7da; color: #842029; padding: 5px 10px; border-radius: 15px; font-weight: bold; border: 1px solid #f5c2c7; }

        /* SEARCH BAR */
        .search-box { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    </style>
    <script>
        const user = JSON.parse(sessionStorage.getItem("user"));
        if (!user) window.location.href = "index.html";
    </script>
</head>
<body>

    <div class="sidebar">
        <h4 class="text-center mt-4 mb-4"><i class="fas fa-warehouse"></i> Gretex ERP</h4>
        <div class="sidebar-menu">
            <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
            <a href="reconciliation.html"><i class="fas fa-tasks"></i> Reconciliation</a>
            <a href="verification.html"><i class="fas fa-database"></i> verification</a>
            <a href="Emp.html"><i class="fas fa-user-plus"></i> Add Employee</a>
            <a href="asset.html"><i class="fas fa-laptop-medical"></i> Add Asset</a>
            <a href="allocate.html"><i class="fas fa-hand-holding"></i> Allocate Asset</a>
            <a href="Return.html"><i class="fas fa-undo"></i> Return Asset</a>
            <a href="Shift.html"><i class="fas fa-truck-moving"></i> Shift Asset</a>
            <a href="Sticker.html" ><i class="fas fa-tags"></i> Create Sticker</a>
            <a href="AssetHistory.html"><i class="fas fa-history"></i> Asset History</a>
            <a href="EmpHistory.html"><i class="fas fa-user-clock"></i> Emp History</a>
            <a href="Repair.html"><i class="fas fa-tools"></i> Maintenance</a>
            <a href="scrap.html"><i class="fas fa-tools"></i> Scrap Asset</a>
            <a href="stock.html" class="active"><i class="fas fa-exchange-alt"></i> Transaction</a>
            <a href="ITChecklist.html"><i class="fas fa-tasks"></i> IT Checklist</a>
            <a href="StockQC.html"><i class="fas fa-clipboard-check"></i> Stock QC</a>
            <a href="data.html"><i class="fas fa-database"></i> Import / Export</a>
           
        </div>
        <div class="sidebar-footer"><a href="#" onclick="logout()" class="mb-3 text-danger"><i class="fas fa-sign-out-alt"></i> Logout</a></div>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-dark m-0"><i class="fas fa-list-alt me-2"></i>Transaction History</h3>
            <button class="btn btn-primary" onclick="loadData()"><i class="fas fa-sync-alt me-2"></i>Refresh Data</button>
        </div>

        <div class="search-box">
            <h6 class="text-muted fw-bold mb-3"><i class="fas fa-search me-2"></i>Advanced Search</h6>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="small fw-bold">Search Keyword</label>
                    <input type="text" id="searchGlobal" class="form-control" placeholder="Asset ID, Name, Emp ID...">
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold">Type</label>
                    <select id="searchType" class="form-select">
                        <option value="">All</option>
                        <option value="IN">IN (Purchase)</option>
                        <option value="OUT">OUT (Issue)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold">From Date</label>
                    <input type="date" id="dateFrom" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold">To Date</label>
                    <input type="date" id="dateTo" class="form-control">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-success w-100 fw-bold" onclick="applyFilter()">
                        <i class="fas fa-filter me-2"></i>Search Records
                    </button>
                </div>
            </div>
        </div>

        <div class="card-custom">
            <div class="table-container">
                <table class="table table-hover table-bordered mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Txn ID</th>
                            <th>Type</th>
                            <th>Item Details</th>
                            <th>Qty</th>
                            <th>Issued To / From</th>
                            <th>Ref Doc</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="txnTableBody">
                        <tr><td colspan="8" class="text-center p-4">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center">
                <small class="text-muted" id="recordCount">Showing 0 records</small>
                <button class="btn btn-sm btn-outline-primary" onclick="showAllData()">View All Records</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbypAYvqG8Lw5-tVd-JaE4PNc6FEzkTRsEBr36uqGwA92wTxxMAOAgV9xeW9QPm4Q-0V2w/exec"; 
        
        let allTransactions = [];

        $(document).ready(function() {
            loadData();
        });

        async function loadData() {
            Swal.fire({ title: 'Loading...', didOpen: () => Swal.showLoading() });
            
            try {
                // Fetch Data from 'Transactions' Sheet using existing API
                const response = await fetch(API_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ action: "exportData", sheetName: "Transactions" }) 
                });
                const result = await response.json();

                if(result.status === "success") {
                    const rows = result.data.slice(1); // Skip Header
                    const headers = result.data[0];

                    // Map Index based on Header Name to avoid column mismatch issues
                    const idxId = 0; // TransactionID
                    const idxDate = 1; // Date
                    const idxType = 2; // Type
                    const idxCat = 3; // Category
                    const idxRef = 4; // ItemID_Ref
                    const idxName = 5; // ItemName
                    const idxQty = 6; // Quantity
                    const idxTo = 7; // IssuedTo_From
                    const idxDoc = 8; // ReferenceDoc
                    const idxRem = 10; // Remarks

                    // Parse Data
                    allTransactions = rows.map(r => ({
                        id: r[idxId],
                        date: r[idxDate],
                        type: r[idxType],
                        item: `${r[idxName]} (${r[idxRef]})`, // Combine Name + ID
                        qty: r[idxQty],
                        party: r[idxTo],
                        ref: r[idxDoc],
                        remarks: r[idxRem],
                        // Helper for sorting
                        timestamp: new Date(r[idxDate]).getTime()
                    }));

                    // SORT: Recent Date First
                    allTransactions.sort((a, b) => b.timestamp - a.timestamp);

                    // Show Top 20 by default
                    renderTable(allTransactions.slice(0, 20));
                    
                    Swal.close();
                } else {
                    throw new Error("Failed to fetch transactions");
                }
            } catch(e) {
                console.error(e);
                Swal.fire("Error", "Could not load transactions.", "error");
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById("txnTableBody");
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted p-4">No records found matching criteria.</td></tr>`;
                document.getElementById("recordCount").innerText = "Showing 0 records";
                return;
            }

            let html = "";
            data.forEach(t => {
                // Date Formatting
                let displayDate = t.date;
                try {
                    let d = new Date(t.date);
                    if(!isNaN(d)) displayDate = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                } catch(e) {}

                // Badge Logic
                const badgeClass = t.type === 'IN' ? 'badge-in' : 'badge-out';
                const typeIcon = t.type === 'IN' ? '<i class="fas fa-arrow-down me-1"></i>' : '<i class="fas fa-arrow-up me-1"></i>';

                html += `
                    <tr>
                        <td>${displayDate}</td>
                        <td class="small text-muted">${t.id}</td>
                        <td><span class="${badgeClass}">${typeIcon}${t.type}</span></td>
                        <td class="fw-bold text-primary text-start">${t.item}</td>
                        <td class="fw-bold">${t.qty}</td>
                        <td class="text-start">${t.party}</td>
                        <td class="small">${t.ref || '-'}</td>
                        <td class="small text-muted text-start">${t.remarks || '-'}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            document.getElementById("recordCount").innerText = `Showing ${data.length} records`;
        }

        // --- FILTER LOGIC ---
        function applyFilter() {
            const keyword = document.getElementById("searchGlobal").value.toLowerCase();
            const type = document.getElementById("searchType").value;
            const fromDate = document.getElementById("dateFrom").value;
            const toDate = document.getElementById("dateTo").value;

            // Convert filter dates to Timestamps for comparison
            const fromTs = fromDate ? new Date(fromDate).setHours(0,0,0,0) : null;
            const toTs = toDate ? new Date(toDate).setHours(23,59,59,999) : null;

            const filtered = allTransactions.filter(t => {
                // 1. Keyword Check (Checks ID, Item Name, Party Name)
                const matchesKeyword = 
                    (t.item && t.item.toLowerCase().includes(keyword)) || 
                    (t.party && t.party.toLowerCase().includes(keyword)) ||
                    (t.id && t.id.toLowerCase().includes(keyword));

                // 2. Type Check
                const matchesType = type === "" || t.type === type;

                // 3. Date Range Check
                let matchesDate = true;
                if (fromTs || toTs) {
                    const rowTs = new Date(t.date).setHours(0,0,0,0); // Normalize time
                    if (fromTs && rowTs < fromTs) matchesDate = false;
                    if (toTs && rowTs > toTs) matchesDate = false;
                }

                return matchesKeyword && matchesType && matchesDate;
            });

            renderTable(filtered);
        }

        // Show All (Clears limits but keeps current array)
        function showAllData() {
            renderTable(allTransactions);
        }

        function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>
